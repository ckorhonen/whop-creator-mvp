name: Regenerate Complete Lockfile

on:
  workflow_dispatch:
  pull_request:
    paths:
      - '.github/workflows/regenerate-complete-lockfile.yml'

permissions:
  contents: write
  pull-requests: write

jobs:
  regenerate-lockfile:
    name: Generate Complete package-lock.json
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Check current lockfile status
        run: |
          echo "ðŸ“Š Current package-lock.json status:"
          if [ -f "package-lock.json" ]; then
            LINES=$(wc -l < package-lock.json)
            PACKAGES=$(jq '.packages | length' package-lock.json || echo "0")
            echo "  Lines: $LINES"
            echo "  Packages: $PACKAGES"
            
            if [ "$PACKAGES" -lt 100 ]; then
              echo "âš ï¸  INCOMPLETE: Only $PACKAGES packages (expected 500+)"
            fi
          else
            echo "âŒ package-lock.json not found"
          fi
      
      - name: Remove incomplete lockfile
        run: |
          echo "ðŸ—‘ï¸  Removing incomplete package-lock.json..."
          rm -f package-lock.json
          rm -rf node_modules
      
      - name: Clear npm cache
        run: |
          echo "ðŸ§¹ Cleaning npm cache..."
          npm cache clean --force
      
      - name: Configure npm for legacy peer deps and network resilience
        run: |
          echo "âš™ï¸  Configuring npm..."
          cat > .npmrc << EOF
          legacy-peer-deps=true
          fetch-timeout=300000
          fetch-retries=5
          fetch-retry-mintimeout=20000
          fetch-retry-maxtimeout=120000
          loglevel=verbose
          EOF
          cat .npmrc
      
      - name: Generate complete lockfile (with retry)
        id: npm-install
        run: |
          echo "ðŸ”¨ Generating complete package-lock.json with all dependencies..."
          
          # Retry logic for npm install
          MAX_ATTEMPTS=3
          ATTEMPT=1
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo ""
            echo "ðŸ”„ Attempt $ATTEMPT of $MAX_ATTEMPTS..."
            
            if npm install; then
              echo ""
              echo "âœ… Lockfile generation complete on attempt $ATTEMPT!"
              exit 0
            else
              EXIT_CODE=$?
              echo ""
              echo "âŒ npm install failed with exit code $EXIT_CODE"
              
              if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
                echo "â³ Waiting 10 seconds before retry..."
                sleep 10
                
                # Clean up for retry
                rm -f package-lock.json
                rm -rf node_modules
                npm cache clean --force
              fi
            fi
            
            ATTEMPT=$((ATTEMPT + 1))
          done
          
          echo ""
          echo "âŒ All $MAX_ATTEMPTS attempts failed"
          echo ""
          echo "ðŸ” Debugging information:"
          echo "Node version: $(node --version)"
          echo "npm version: $(npm --version)"
          echo "npm config list:"
          npm config list
          
          exit 1
      
      - name: Verify generated lockfile
        if: success()
        continue-on-error: true
        id: verify
        run: |
          echo "ðŸ” Verifying generated lockfile..."
          
          if [ ! -f "package-lock.json" ]; then
            echo "âŒ Failed to generate package-lock.json"
            exit 1
          fi
          
          LINES=$(wc -l < package-lock.json)
          PACKAGES=$(jq '.packages | length' package-lock.json)
          INTEGRITY_COUNT=$(jq '[.packages | to_entries[] | select(.value.integrity)] | length' package-lock.json)
          
          echo "ðŸ“Š Generated lockfile stats:"
          echo "  Lines: $LINES"
          echo "  Total packages: $PACKAGES"
          echo "  With integrity: $INTEGRITY_COUNT"
          
          # Verify it's complete (should have many packages)
          # Note: Adjusted threshold since this is a smaller project
          if [ "$PACKAGES" -lt 50 ]; then
            echo "âš ï¸  Warning: Lockfile has fewer packages than expected ($PACKAGES packages)"
            echo "â„¹ï¸  This might be normal for a small project, but verify manually"
          fi
          
          # Verify no placeholder hashes
          if grep -q "example-.*-hash" package-lock.json; then
            echo "âŒ Found placeholder integrity hashes"
            exit 1
          fi
          
          echo "âœ… Lockfile verification passed!"
          echo "âœ… Generated $PACKAGES packages with $INTEGRITY_COUNT integrity hashes"
      
      - name: Test installation with npm ci
        if: success()
        run: |
          echo "ðŸ§ª Testing npm ci with generated lockfile..."
          rm -rf node_modules
          npm ci
          echo "âœ… npm ci successful!"
      
      - name: Commit and push complete lockfile
        # Only commit when manually triggered, not on PR events (read-only context)
        if: success() && github.event_name == 'workflow_dispatch'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if git diff --quiet package-lock.json .npmrc; then
            echo "â„¹ï¸  No changes to package-lock.json or .npmrc"
            exit 0
          fi
          
          git add package-lock.json .npmrc
          git commit -m "ðŸ”’ Regenerate complete package-lock.json with all dependencies

- Generated complete lockfile with all transitive dependencies
- Includes all packages with valid SHA-512 integrity hashes
- Added npm configuration for better network resilience
- Fixes incomplete lockfile causing workflow failures

This fixes the auto-fix-lockfile workflow failures by providing
a complete dependency tree with proper integrity verification."
          
          git push
          
          echo "âœ… Complete lockfile committed and pushed!"
      
      - name: Summary
        if: always()
        run: |
          if [ -f "package-lock.json" ]; then
            PACKAGES=$(jq '.packages | length' package-lock.json)
            INTEGRITY_COUNT=$(jq '[.packages | to_entries[] | select(.value.integrity)] | length' package-lock.json)
            
            echo "ðŸŽ‰ Lockfile Regeneration Summary"
            echo ""
            echo "ðŸ“Š Final Stats:"
            echo "  Total packages: $PACKAGES"
            echo "  With integrity: $INTEGRITY_COUNT"
            echo ""
            
            if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
              echo "âœ… The complete package-lock.json has been committed to this branch"
              echo "âœ… All future workflow runs will have proper dependencies"
              echo "âœ… npm ci will work correctly with the complete lockfile"
            else
              echo "â„¹ï¸  This was a validation run (PR trigger)"
              echo "â„¹ï¸  To commit changes, manually trigger this workflow via workflow_dispatch"
            fi
          else
            echo "âŒ Workflow failed - package-lock.json was not generated"
            echo ""
            echo "ðŸ” Troubleshooting steps:"
            echo "  1. Check the npm install logs above for specific errors"
            echo "  2. Verify package.json has valid dependencies"
            echo "  3. Try running 'npm install' locally to reproduce the issue"
            echo "  4. Check for network issues or npm registry problems"
          fi
