name: Regenerate Complete Package Lock

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  regenerate-lockfile:
    name: Regenerate Complete Lockfile
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Clean existing lockfile and cache
        run: |
          echo "ğŸ§¹ Cleaning npm cache and existing lockfile..."
          rm -f package-lock.json
          rm -rf node_modules
          npm cache clean --force
          echo "âœ… Cleanup complete"
          
      - name: Regenerate complete package-lock.json
        run: |
          echo "ğŸ”¨ Regenerating complete package-lock.json with ALL dependencies..."
          npm install
          
          if [ ! -f "package-lock.json" ]; then
            echo "âŒ Failed to generate package-lock.json"
            exit 1
          fi
          
          # Count packages to verify completeness
          PACKAGE_COUNT=$(node -e "console.log(Object.keys(require('./package-lock.json').packages).length)")
          echo "ğŸ“¦ Generated lockfile with $PACKAGE_COUNT packages"
          
          if [ "$PACKAGE_COUNT" -lt 100 ]; then
            echo "âš ï¸  Warning: Only $PACKAGE_COUNT packages found - lockfile may be incomplete"
            echo "Expected at least 100+ packages for all dependencies"
          else
            echo "âœ… Lockfile appears complete with $PACKAGE_COUNT packages"
          fi
          
      - name: Verify lockfile integrity
        run: |
          echo "ğŸ” Verifying lockfile integrity..."
          
          # Check for placeholder hashes
          if grep -q "example-integrity-hash" package-lock.json || grep -q "example-.*-hash" package-lock.json; then
            echo "âŒ Found placeholder integrity hashes!"
            exit 1
          fi
          
          # Count packages with integrity hashes
          INTEGRITY_COUNT=$(node -e "const lock = require('./package-lock.json'); console.log(Object.values(lock.packages).filter(p => p.integrity).length)")
          echo "âœ… Found $INTEGRITY_COUNT packages with valid integrity hashes"
          
      - name: Test with npm ci
        run: |
          echo "ğŸ§ª Testing npm ci with regenerated lockfile..."
          rm -rf node_modules
          npm ci
          echo "âœ… npm ci successful - lockfile is valid!"
          
      - name: Commit regenerated lockfile
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Check if there are changes
          if git diff --quiet package-lock.json; then
            echo "âœ… No changes to package-lock.json"
            exit 0
          fi
          
          echo "ğŸ“ Changes detected in package-lock.json"
          git status
          
          # Stage changes
          git add package-lock.json
          
          # Commit changes
          git commit -m "fix: Regenerate complete package-lock.json with all dependencies

- Removed incomplete lockfile
- Regenerated with complete dependency trees
- Now includes all transitive dependencies
- Verified with npm ci
- Fixes workflow run #19203441475"
          
          # Pull latest changes to avoid conflicts
          echo "ğŸ”„ Pulling latest changes..."
          git pull --rebase origin fix-complete-lockfile-regeneration-copilot || true
          
          # Push changes with explicit branch reference
          echo "ğŸš€ Pushing changes..."
          if git push origin HEAD:fix-complete-lockfile-regeneration-copilot; then
            echo "âœ… Successfully committed and pushed regenerated lockfile"
          else
            echo "âŒ Failed to push changes"
            echo "Debug information:"
            echo "Current branch: $(git branch --show-current)"
            echo "Current ref: ${{ github.ref }}"
            echo "Remote URL: $(git remote get-url origin)"
            echo "Git status:"
            git status
            exit 1
          fi
