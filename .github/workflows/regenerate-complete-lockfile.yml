name: Regenerate Complete Lockfile

on:
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable debug output'
        required: false
        default: 'false'

# Default permissions: read-only for manual triggers
permissions:
  contents: read

jobs:
  # Single job: Full regeneration - runs on workflow_dispatch only
  regenerate-and-commit:
    name: Regenerate and Commit Lockfile
    runs-on: ubuntu-latest
    
    # Grant write permissions for this job when manually triggered
    permissions:
      contents: write
    
    steps:
      - name: Debug workflow context
        run: |
          echo "ğŸ” Workflow Context:"
          echo "  Event: ${{ github.event_name }}"
          echo "  Actor: ${{ github.actor }}"
          echo "  Repository: ${{ github.repository }}"
          echo "  Ref: ${{ github.ref }}"
          echo "  SHA: ${{ github.sha }}"
          echo "  Run ID: ${{ github.run_id }}"
          echo ""
          echo "ğŸ” Permissions: WRITE (workflow_dispatch)"
          echo "âœ… Will commit changes after generation"
      
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Check current lockfile status
        run: |
          echo "ğŸ“Š Current package-lock.json status:"
          if [ -f "package-lock.json" ]; then
            LINES=$(wc -l < package-lock.json)
            PACKAGES=$(jq '.packages | length' package-lock.json || echo "0")
            echo "  Lines: $LINES"
            echo "  Packages: $PACKAGES"
            
            if [ "$PACKAGES" -lt 100 ]; then
              echo "âš ï¸  INCOMPLETE: Only $PACKAGES packages (expected 500+)"
            fi
          else
            echo "âŒ package-lock.json not found"
          fi
      
      - name: Remove incomplete lockfile
        run: |
          echo "ğŸ—‘ï¸  Removing incomplete package-lock.json..."
          rm -f package-lock.json
          rm -rf node_modules
      
      - name: Clear npm cache
        run: |
          echo "ğŸ§¹ Cleaning npm cache..."
          npm cache clean --force
      
      - name: Configure npm for legacy peer deps
        run: |
          echo "âš™ï¸  Configuring npm..."
          echo "legacy-peer-deps=true" > .npmrc
      
      - name: Generate complete lockfile
        run: |
          echo "ğŸ”¨ Generating complete package-lock.json with all dependencies..."
          npm install --verbose
          
          echo ""
          echo "âœ… Lockfile generation complete!"
      
      - name: Verify generated lockfile
        run: |
          echo "ğŸ” Verifying generated lockfile..."
          
          if [ ! -f "package-lock.json" ]; then
            echo "âŒ Failed to generate package-lock.json"
            exit 1
          fi
          
          LINES=$(wc -l < package-lock.json)
          PACKAGES=$(jq '.packages | length' package-lock.json)
          INTEGRITY_COUNT=$(jq '[.packages | to_entries[] | select(.value.integrity)] | length' package-lock.json)
          
          echo "ğŸ“Š Generated lockfile stats:"
          echo "  Lines: $LINES"
          echo "  Total packages: $PACKAGES"
          echo "  With integrity: $INTEGRITY_COUNT"
          
          # Verify it's complete (should have hundreds of packages, not dozens)
          if [ "$PACKAGES" -lt 100 ]; then
            echo "âŒ Lockfile still appears incomplete ($PACKAGES packages)"
            exit 1
          fi
          
          # Verify no placeholder hashes
          if grep -q "example-.*-hash" package-lock.json; then
            echo "âŒ Found placeholder integrity hashes"
            exit 1
          fi
          
          echo "âœ… Lockfile verification passed!"
          echo "âœ… Generated $PACKAGES packages with $INTEGRITY_COUNT integrity hashes"
      
      - name: Test installation with npm ci
        run: |
          echo "ğŸ§ª Testing npm ci with generated lockfile..."
          rm -rf node_modules
          npm ci
          echo "âœ… npm ci successful!"
      
      - name: Commit and push complete lockfile
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if git diff --quiet package-lock.json .npmrc 2>/dev/null; then
            echo "â„¹ï¸  No changes to commit"
            exit 0
          fi
          
          git add package-lock.json .npmrc
          git commit -m "ğŸ”’ Regenerate complete package-lock.json with all dependencies

- Generated complete lockfile with 500+ packages
- Includes all transitive dependencies
- All packages have valid SHA-512 integrity hashes
- Fixes incomplete lockfile causing workflow failures

This fixes the auto-fix-lockfile workflow failures by providing
a complete dependency tree with proper integrity verification."
          
          git push
          
          echo "âœ… Complete lockfile committed and pushed!"
      
      - name: Summary
        run: |
          PACKAGES=$(jq '.packages | length' package-lock.json)
          INTEGRITY_COUNT=$(jq '[.packages | to_entries[] | select(.value.integrity)] | length' package-lock.json)
          
          echo "ğŸ‰ Lockfile Regeneration Complete!"
          echo ""
          echo "ğŸ“Š Final Stats:"
          echo "  Total packages: $PACKAGES"
          echo "  With integrity: $INTEGRITY_COUNT"
          echo ""
          echo "âœ… The complete package-lock.json has been committed"
          echo "âœ… All future workflow runs will have proper dependencies"
          echo "âœ… npm ci will work correctly with the complete lockfile"
