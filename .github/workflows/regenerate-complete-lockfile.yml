name: Regenerate Complete Lockfile

on:
  workflow_dispatch:
  pull_request:
    paths:
      - '.github/workflows/regenerate-complete-lockfile.yml'

# Permissions configuration
# write access for workflow_dispatch, read for pull_request
permissions:
  contents: write
  pull-requests: read

jobs:
  regenerate-lockfile:
    name: Generate Complete package-lock.json
    runs-on: ubuntu-latest
    
    steps:
      - name: Debug workflow context
        run: |
          echo "üîç Workflow Context:"
          echo "  Event: ${{ github.event_name }}"
          echo "  Actor: ${{ github.actor }}"
          echo "  Repository: ${{ github.repository }}"
          echo "  Ref: ${{ github.ref }}"
          echo "  SHA: ${{ github.sha }}"
          echo "  Run ID: ${{ github.run_id }}"
          echo ""
          echo "üîê Permissions:"
          echo "  Event type: ${{ github.event_name }}"
          echo "  Will commit: ${{ github.event_name == 'workflow_dispatch' }}"
      
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          # For workflow_dispatch, we need to ensure we can push
          persist-credentials: ${{ github.event_name == 'workflow_dispatch' }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Check current lockfile status
        run: |
          echo "üìä Current package-lock.json status:"
          if [ -f "package-lock.json" ]; then
            LINES=$(wc -l < package-lock.json)
            PACKAGES=$(jq '.packages | length' package-lock.json || echo "0")
            echo "  Lines: $LINES"
            echo "  Packages: $PACKAGES"
            
            if [ "$PACKAGES" -lt 100 ]; then
              echo "‚ö†Ô∏è  INCOMPLETE: Only $PACKAGES packages (expected 500+)"
            fi
          else
            echo "‚ùå package-lock.json not found"
          fi
      
      - name: Remove incomplete lockfile
        run: |
          echo "üóëÔ∏è  Removing incomplete package-lock.json..."
          rm -f package-lock.json
          rm -rf node_modules
      
      - name: Clear npm cache
        run: |
          echo "üßπ Cleaning npm cache..."
          npm cache clean --force
      
      - name: Configure npm for legacy peer deps
        run: |
          echo "‚öôÔ∏è  Configuring npm..."
          echo "legacy-peer-deps=true" > .npmrc
      
      - name: Generate complete lockfile
        run: |
          echo "üî® Generating complete package-lock.json with all dependencies..."
          npm install --verbose
          
          echo ""
          echo "‚úÖ Lockfile generation complete!"
      
      - name: Verify generated lockfile
        run: |
          echo "üîç Verifying generated lockfile..."
          
          if [ ! -f "package-lock.json" ]; then
            echo "‚ùå Failed to generate package-lock.json"
            exit 1
          fi
          
          LINES=$(wc -l < package-lock.json)
          PACKAGES=$(jq '.packages | length' package-lock.json)
          INTEGRITY_COUNT=$(jq '[.packages | to_entries[] | select(.value.integrity)] | length' package-lock.json)
          
          echo "üìä Generated lockfile stats:"
          echo "  Lines: $LINES"
          echo "  Total packages: $PACKAGES"
          echo "  With integrity: $INTEGRITY_COUNT"
          
          # Verify it's complete (should have hundreds of packages, not dozens)
          if [ "$PACKAGES" -lt 100 ]; then
            echo "‚ùå Lockfile still appears incomplete ($PACKAGES packages)"
            exit 1
          fi
          
          # Verify no placeholder hashes
          if grep -q "example-.*-hash" package-lock.json; then
            echo "‚ùå Found placeholder integrity hashes"
            exit 1
          fi
          
          echo "‚úÖ Lockfile verification passed!"
          echo "‚úÖ Generated $PACKAGES packages with $INTEGRITY_COUNT integrity hashes"
      
      - name: Test installation with npm ci
        run: |
          echo "üß™ Testing npm ci with generated lockfile..."
          rm -rf node_modules
          npm ci
          echo "‚úÖ npm ci successful!"
      
      - name: Commit and push complete lockfile
        # Only commit when manually triggered, not on PR events (read-only context)
        if: github.event_name == 'workflow_dispatch'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if git diff --quiet package-lock.json; then
            echo "‚ÑπÔ∏è  No changes to package-lock.json"
            exit 0
          fi
          
          git add package-lock.json .npmrc
          git commit -m "üîí Regenerate complete package-lock.json with all dependencies" -m "" -m "- Generated complete lockfile with 500+ packages" -m "- Includes all transitive dependencies" -m "- All packages have valid SHA-512 integrity hashes" -m "- Fixes incomplete lockfile causing workflow failures" -m "" -m "This fixes the auto-fix-lockfile workflow failures by providing" -m "a complete dependency tree with proper integrity verification."
          
          git push
          
          echo "‚úÖ Complete lockfile committed and pushed!"
      
      - name: Summary
        run: |
          PACKAGES=$(jq '.packages | length' package-lock.json)
          INTEGRITY_COUNT=$(jq '[.packages | to_entries[] | select(.value.integrity)] | length' package-lock.json)
          
          echo "üéâ Lockfile Regeneration Complete!"
          echo ""
          echo "üìä Final Stats:"
          echo "  Total packages: $PACKAGES"
          echo "  With integrity: $INTEGRITY_COUNT"
          echo ""
          
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "‚úÖ The complete package-lock.json has been committed to this branch"
            echo "‚úÖ All future workflow runs will have proper dependencies"
            echo "‚úÖ npm ci will work correctly with the complete lockfile"
          else
            echo "‚ÑπÔ∏è  This was a validation run (PR trigger)"
            echo "‚ÑπÔ∏è  To commit changes, manually trigger this workflow via workflow_dispatch"
          fi
