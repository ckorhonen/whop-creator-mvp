name: Regenerate Complete Lockfile

on:
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable debug output'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

# Workflow-level permissions - explicit and comprehensive
permissions:
  contents: write      # Allow pushing commits
  actions: read        # Allow reading workflow status
  pull-requests: write # Allow PR operations if needed
  statuses: write      # Allow status updates

jobs:
  regenerate-and-commit:
    name: Regenerate and Commit Lockfile
    runs-on: ubuntu-latest
    
    # Job permissions must match workflow-level to avoid override issues
    permissions:
      contents: write
      actions: read
      pull-requests: write
      statuses: write
    
    steps:
      - name: Debug workflow context
        env:
          EVENT_NAME: ${{ github.event_name }}
          ACTOR: ${{ github.actor }}
          REPOSITORY: ${{ github.repository }}
          REF: ${{ github.ref }}
          REF_NAME: ${{ github.ref_name }}
          SHA: ${{ github.sha }}
          RUN_ID: ${{ github.run_id }}
        run: |
          echo "üîç Workflow Context:"
          echo "  Event: $EVENT_NAME"
          echo "  Actor: $ACTOR"
          echo "  Repository: $REPOSITORY"
          echo "  Ref: $REF"
          echo "  Ref Name: $REF_NAME"
          echo "  SHA: $SHA"
          echo "  Run ID: $RUN_ID"
          echo ""
          echo "üîê Permissions: WRITE (workflow_dispatch)"
          echo "‚úÖ Will commit changes after generation"
      
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
          fetch-depth: 0  # Fetch complete history for proper git operations
          ref: ${{ github.ref_name }}  # Explicitly checkout the current branch
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Check current lockfile status
        run: |
          echo "üìä Current package-lock.json status:"
          if [ -f "package-lock.json" ]; then
            LINES=$(wc -l < package-lock.json)
            PACKAGES=$(jq '.packages | length' package-lock.json || echo "0")
            echo "  Lines: $LINES"
            echo "  Packages: $PACKAGES"
            
            if [ "$PACKAGES" -lt 100 ]; then
              echo "‚ö†Ô∏è  INCOMPLETE: Only $PACKAGES packages (expected 500+)"
            else
              echo "‚úÖ Lockfile appears complete with $PACKAGES packages"
            fi
          else
            echo "‚ùå package-lock.json not found"
          fi
      
      - name: Remove incomplete lockfile
        run: |
          echo "üóëÔ∏è  Removing incomplete package-lock.json..."
          rm -f package-lock.json
          rm -rf node_modules
      
      - name: Clear npm cache
        run: |
          echo "üßπ Cleaning npm cache..."
          npm cache clean --force
      
      - name: Configure npm for legacy peer deps
        run: |
          echo "‚öôÔ∏è  Configuring npm..."
          echo "legacy-peer-deps=true" > .npmrc
      
      - name: Generate complete lockfile
        run: |
          echo "üî® Generating complete package-lock.json with all dependencies..."
          npm install --verbose
          
          echo ""
          echo "‚úÖ Lockfile generation complete!"
      
      - name: Verify generated lockfile
        run: |
          echo "üîç Verifying generated lockfile..."
          
          if [ ! -f "package-lock.json" ]; then
            echo "‚ùå Failed to generate package-lock.json"
            exit 1
          fi
          
          LINES=$(wc -l < package-lock.json)
          PACKAGES=$(jq '.packages | length' package-lock.json)
          INTEGRITY_COUNT=$(jq '[.packages | to_entries[] | select(.value.integrity)] | length' package-lock.json)
          
          echo "üìä Generated lockfile stats:"
          echo "  Lines: $LINES"
          echo "  Total packages: $PACKAGES"
          echo "  With integrity: $INTEGRITY_COUNT"
          
          # Verify it's complete (should have hundreds of packages, not dozens)
          if [ "$PACKAGES" -lt 100 ]; then
            echo "‚ùå Lockfile still appears incomplete ($PACKAGES packages)"
            exit 1
          fi
          
          # Verify no placeholder hashes
          if grep -q "example-.*-hash" package-lock.json; then
            echo "‚ùå Found placeholder integrity hashes"
            exit 1
          fi
          
          echo "‚úÖ Lockfile verification passed!"
          echo "‚úÖ Generated $PACKAGES packages with $INTEGRITY_COUNT integrity hashes"
      
      - name: Test installation with npm ci
        run: |
          echo "üß™ Testing npm ci with generated lockfile..."
          rm -rf node_modules
          npm ci
          echo "‚úÖ npm ci successful!"
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Check for changes
        id: check_changes
        run: |
          # Check if there are any changes to commit
          git add package-lock.json .npmrc
          
          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  No changes to commit - lockfile is already up to date"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Changes detected in lockfile"
          fi
      
      - name: Commit and push complete lockfile
        if: steps.check_changes.outputs.has_changes == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH_NAME: ${{ github.ref_name }}
          REPO_NAME: ${{ github.repository }}
        run: |
          # Create commit with properly formatted multi-line message
          git commit -m "üîí Regenerate complete package-lock.json with all dependencies" \
                     -m "" \
                     -m "- Generated complete lockfile with 500+ packages" \
                     -m "- Includes all transitive dependencies" \
                     -m "- All packages have valid SHA-512 integrity hashes" \
                     -m "- Fixes incomplete lockfile causing workflow failures" \
                     -m "" \
                     -m "This fixes the auto-fix-lockfile workflow failures by providing" \
                     -m "a complete dependency tree with proper integrity verification."
          
          # Set up authentication
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${REPO_NAME}.git"
          
          # Push with retry logic
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          echo "üì§ Pushing changes to ${BRANCH_NAME}..."
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if git push origin "HEAD:refs/heads/${BRANCH_NAME}"; then
              echo "‚úÖ Complete lockfile committed and pushed!"
              exit 0
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "‚ö†Ô∏è  Push failed, retrying ($RETRY_COUNT/$MAX_RETRIES)..."
                sleep 2
                # Pull any changes before retrying
                git pull --rebase origin "${BRANCH_NAME}" || true
              else
                echo "‚ùå Push failed after $MAX_RETRIES attempts. Diagnostics:"
                echo ""
                echo "Current branch: ${BRANCH_NAME}"
                echo "Git status:"
                git status
                echo ""
                echo "Remote info:"
                git remote -v
                echo ""
                echo "Recent commits:"
                git log --oneline -3
                echo ""
                echo "Possible causes:"
                echo "  - Branch protection rules require reviews"
                echo "  - Token lacks sufficient permissions"
                echo "  - Remote branch has conflicting changes"
                exit 1
              fi
            fi
          done
      
      - name: Summary
        if: success()
        env:
          HAS_CHANGES: ${{ steps.check_changes.outputs.has_changes }}
        run: |
          if [ "${HAS_CHANGES}" == "true" ]; then
            PACKAGES=$(jq '.packages | length' package-lock.json)
            INTEGRITY_COUNT=$(jq '[.packages | to_entries[] | select(.value.integrity)] | length' package-lock.json)
            
            echo "üéâ Lockfile Regeneration Complete!"
            echo ""
            echo "üìä Final Stats:"
            echo "  Total packages: $PACKAGES"
            echo "  With integrity: $INTEGRITY_COUNT"
            echo ""
            echo "‚úÖ The complete package-lock.json has been committed"
            echo "‚úÖ All future workflow runs will have proper dependencies"
            echo "‚úÖ npm ci will work correctly with the complete lockfile"
          else
            echo "‚ÑπÔ∏è  Lockfile was already up to date - no changes needed"
          fi
