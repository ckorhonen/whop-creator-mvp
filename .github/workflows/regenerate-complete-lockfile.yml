name: Regenerate Complete Lockfile

on:
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable debug logging'
        required: false
        default: 'false'
  push:
    branches:
      - fix-complete-lockfile

permissions:
  contents: write
  pull-requests: write

jobs:
  regenerate:
    name: Generate Complete package-lock.json
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: fix-complete-lockfile
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Remove incomplete lockfile if exists
        run: |
          echo "üßπ Removing incomplete lockfile..."
          rm -f package-lock.json
          rm -rf node_modules
          npm cache clean --force
          
      - name: Generate complete package-lock.json
        run: |
          echo "üî® Generating complete package-lock.json with all dependencies..."
          npm install
          
          if [ ! -f "package-lock.json" ]; then
            echo "‚ùå Failed to generate package-lock.json"
            exit 1
          fi
          
          # Count packages
          PACKAGE_COUNT=$(node -e "const lock = require('./package-lock.json'); console.log(Object.keys(lock.packages || {}).length)")
          echo "‚úÖ Generated lockfile with ${PACKAGE_COUNT} packages"
          
      - name: Verify lockfile completeness
        run: |
          echo "üîç Verifying lockfile completeness..."
          
          # Check that we have a substantial number of packages (should be 500+)
          PACKAGE_COUNT=$(node -e "const lock = require('./package-lock.json'); console.log(Object.keys(lock.packages || {}).length)")
          
          if [ "$PACKAGE_COUNT" -lt 100 ]; then
            echo "‚ùå Lockfile appears incomplete (only $PACKAGE_COUNT packages)"
            exit 1
          fi
          
          echo "‚úÖ Lockfile contains $PACKAGE_COUNT packages - looks complete!"
          
          # Verify some key packages exist
          node -e "
            const lock = require('./package-lock.json');
            const required = [
              'node_modules/vite',
              'node_modules/@vitejs/plugin-react', 
              'node_modules/@babel/core',
              'node_modules/eslint',
              'node_modules/typescript',
              'node_modules/react',
              'node_modules/react-dom'
            ];
            
            const missing = required.filter(pkg => !lock.packages[pkg]);
            
            if (missing.length > 0) {
              console.error('‚ùå Missing required packages:', missing);
              process.exit(1);
            }
            
            console.log('‚úÖ All key packages present in lockfile');
          "
          
      - name: Test installation
        run: |
          echo "üß™ Testing clean installation..."
          rm -rf node_modules
          npm ci
          echo "‚úÖ npm ci successful with generated lockfile"
          
      - name: Commit complete lockfile
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if git diff --quiet package-lock.json; then
            echo "‚ÑπÔ∏è  No changes to lockfile"
          else
            git add package-lock.json
            git commit -m "Generate complete package-lock.json with all dependencies" \
              -m "" \
              -m "- Generated complete lockfile with all transitive dependencies" \
              -m "- Includes valid SHA-512 integrity hashes for all packages" \
              -m "- Verified installation with npm ci" \
              -m "- Fixes incomplete dependency tracking"
            git push
            echo "‚úÖ Complete lockfile committed and pushed"
          fi
