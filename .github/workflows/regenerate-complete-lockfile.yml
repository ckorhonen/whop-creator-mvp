name: Regenerate Complete Lockfile

on:
  workflow_dispatch:

# Set write permissions for workflow_dispatch events
# PR events will only run read-only validation steps
permissions:
  contents: write
  pull-requests: write

jobs:
  regenerate-lockfile:
    name: Generate Complete package-lock.json
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref }}
          # Use PAT if available for better permissions, otherwise use GITHUB_TOKEN
          token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Check current lockfile status
        run: |
          echo "ğŸ“Š Current package-lock.json status:"
          if [ -f "package-lock.json" ]; then
            LINES=$(wc -l < package-lock.json)
            PACKAGES=$(jq '.packages | length' package-lock.json || echo "0")
            echo "  Lines: $LINES"
            echo "  Packages: $PACKAGES"
            
            if [ "$PACKAGES" -lt 100 ]; then
              echo "âš ï¸  INCOMPLETE: Only $PACKAGES packages (expected 500+)"
            fi
          else
            echo "âŒ package-lock.json not found"
          fi
      
      - name: Remove incomplete lockfile
        run: |
          echo "ğŸ—‘ï¸  Removing incomplete package-lock.json..."
          rm -f package-lock.json
          rm -rf node_modules
      
      - name: Clear npm cache
        run: |
          echo "ğŸ§¹ Cleaning npm cache..."
          npm cache clean --force
      
      - name: Configure npm for legacy peer deps
        run: |
          echo "âš™ï¸  Configuring npm..."
          echo "legacy-peer-deps=true" > .npmrc
      
      - name: Generate complete lockfile
        run: |
          echo "ğŸ”¨ Generating complete package-lock.json with all dependencies..."
          npm install --verbose
          
          echo ""
          echo "âœ… Lockfile generation complete!"
      
      - name: Verify generated lockfile
        run: |
          echo "ğŸ” Verifying generated lockfile..."
          
          if [ ! -f "package-lock.json" ]; then
            echo "âŒ Failed to generate package-lock.json"
            exit 1
          fi
          
          LINES=$(wc -l < package-lock.json)
          PACKAGES=$(jq '.packages | length' package-lock.json)
          INTEGRITY_COUNT=$(jq '[.packages | to_entries[] | select(.value.integrity)] | length' package-lock.json)
          
          echo "ğŸ“Š Generated lockfile stats:"
          echo "  Lines: $LINES"
          echo "  Total packages: $PACKAGES"
          echo "  With integrity: $INTEGRITY_COUNT"
          
          # Verify it's complete (should have hundreds of packages, not dozens)
          if [ "$PACKAGES" -lt 100 ]; then
            echo "âŒ Lockfile still appears incomplete ($PACKAGES packages)"
            exit 1
          fi
          
          # Verify no placeholder hashes
          if grep -q "example-.*-hash" package-lock.json; then
            echo "âŒ Found placeholder integrity hashes"
            exit 1
          fi
          
          echo "âœ… Lockfile verification passed!"
          echo "âœ… Generated $PACKAGES packages with $INTEGRITY_COUNT integrity hashes"
      
      - name: Test installation with npm ci
        run: |
          echo "ğŸ§ª Testing npm ci with generated lockfile..."
          rm -rf node_modules
          npm ci
          echo "âœ… npm ci successful!"
      
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PAT || secrets.GITHUB_TOKEN }}
          commit-message: |
            ğŸ”’ Regenerate complete package-lock.json with all dependencies
            
            - Generated complete lockfile with 500+ packages
            - Includes all transitive dependencies
            - All packages have valid SHA-512 integrity hashes
            - Fixes incomplete lockfile causing workflow failures
            
            This fixes the auto-fix-lockfile workflow failures by providing
            a complete dependency tree with proper integrity verification.
          branch: regenerate-lockfile-${{ github.run_number }}
          delete-branch: true
          title: "ğŸ”’ Regenerate complete package-lock.json"
          body: |
            ## ğŸ”’ Lockfile Regeneration
            
            This PR regenerates the complete `package-lock.json` with all dependencies and proper integrity hashes.
            
            ### Changes
            - âœ… Generated complete lockfile with 500+ packages
            - âœ… All packages have valid SHA-512 integrity hashes
            - âœ… Verified with `npm ci`
            - âœ… Configured npm with legacy peer deps
            
            ### Testing
            The lockfile has been tested and verified to work with `npm ci`.
            
            ### Why
            This fixes workflow failures caused by incomplete lockfile with missing dependencies and integrity hashes.
            
            ---
            *Generated by workflow run #${{ github.run_number }}*
          labels: |
            dependencies
            automated
      
      - name: Summary
        run: |
          PACKAGES=$(jq '.packages | length' package-lock.json)
          INTEGRITY_COUNT=$(jq '[.packages | to_entries[] | select(.value.integrity)] | length' package-lock.json)
          
          echo "ğŸ‰ Lockfile Regeneration Complete!"
          echo ""
          echo "ğŸ“Š Final Stats:"
          echo "  Total packages: $PACKAGES"
          echo "  With integrity: $INTEGRITY_COUNT"
          echo ""
          echo "âœ… A pull request has been created with the complete package-lock.json"
          echo "âœ… Review and merge the PR to apply the changes"
          echo "âœ… npm ci will work correctly with the complete lockfile"
