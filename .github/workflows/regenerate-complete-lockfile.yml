name: Regenerate Complete Lockfile

on:
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable debug output'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
  # Add push trigger but we'll skip execution unless it's workflow_dispatch
  # This prevents immediate workflow failure when the workflow file is updated
  push:
    paths:
      - '.github/workflows/regenerate-complete-lockfile.yml'

# Workflow-level permissions - explicit and comprehensive
# This ensures workflow_dispatch has all necessary permissions
permissions:
  contents: write      # Allow pushing commits
  actions: read        # Allow reading workflow status
  pull-requests: write # Allow PR operations if needed
  statuses: write      # Allow status updates

jobs:
  regenerate-and-commit:
    name: Regenerate and Commit Lockfile
    runs-on: ubuntu-latest
    
    # Job permissions must match workflow-level to avoid override issues
    # When job-level permissions are set, they override workflow-level
    permissions:
      contents: write
      actions: read
      pull-requests: write
      statuses: write
    
    steps:
      - name: Check if workflow should run
        id: should_run
        run: |
          # Only run on workflow_dispatch events
          if [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
            echo "‚è≠Ô∏è  Skipping: This workflow only runs on manual trigger (workflow_dispatch)"
            echo "   Current trigger: ${{ github.event_name }}"
            echo "   To run this workflow, use the 'Run workflow' button in the Actions tab"
            echo "should_run=false" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Running: Triggered by workflow_dispatch"
            echo "should_run=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Debug workflow context
        if: steps.should_run.outputs.should_run == 'true'
        run: |
          echo "üîç Workflow Context:"
          echo "  Event: ${{ github.event_name }}"
          echo "  Actor: ${{ github.actor }}"
          echo "  Repository: ${{ github.repository }}"
          echo "  Ref: ${{ github.ref }}"
          echo "  SHA: ${{ github.sha }}"
          echo "  Run ID: ${{ github.run_id }}"
          echo ""
          echo "üîê Permissions: WRITE (workflow_dispatch)"
          echo "‚úÖ Will commit changes after generation"
      
      - name: Checkout repository
        if: steps.should_run.outputs.should_run == 'true'
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
          fetch-depth: 0  # Fetch complete history for proper git operations
      
      - name: Setup Node.js
        if: steps.should_run.outputs.should_run == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Check current lockfile status
        if: steps.should_run.outputs.should_run == 'true'
        run: |
          echo "üìä Current package-lock.json status:"
          if [ -f "package-lock.json" ]; then
            LINES=$(wc -l < package-lock.json)
            PACKAGES=$(jq '.packages | length' package-lock.json || echo "0")
            echo "  Lines: $LINES"
            echo "  Packages: $PACKAGES"
            
            if [ "$PACKAGES" -lt 100 ]; then
              echo "‚ö†Ô∏è  INCOMPLETE: Only $PACKAGES packages (expected 500+)"
            fi
          else
            echo "‚ùå package-lock.json not found"
          fi
      
      - name: Remove incomplete lockfile
        if: steps.should_run.outputs.should_run == 'true'
        run: |
          echo "üóëÔ∏è  Removing incomplete package-lock.json..."
          rm -f package-lock.json
          rm -rf node_modules
      
      - name: Clear npm cache
        if: steps.should_run.outputs.should_run == 'true'
        run: |
          echo "üßπ Cleaning npm cache..."
          npm cache clean --force
      
      - name: Configure npm for legacy peer deps
        if: steps.should_run.outputs.should_run == 'true'
        run: |
          echo "‚öôÔ∏è  Configuring npm..."
          echo "legacy-peer-deps=true" > .npmrc
      
      - name: Generate complete lockfile
        if: steps.should_run.outputs.should_run == 'true'
        run: |
          echo "üî® Generating complete package-lock.json with all dependencies..."
          npm install --verbose
          
          echo ""
          echo "‚úÖ Lockfile generation complete!"
      
      - name: Verify generated lockfile
        if: steps.should_run.outputs.should_run == 'true'
        run: |
          echo "üîç Verifying generated lockfile..."
          
          if [ ! -f "package-lock.json" ]; then
            echo "‚ùå Failed to generate package-lock.json"
            exit 1
          fi
          
          LINES=$(wc -l < package-lock.json)
          PACKAGES=$(jq '.packages | length' package-lock.json)
          INTEGRITY_COUNT=$(jq '[.packages | to_entries[] | select(.value.integrity)] | length' package-lock.json)
          
          echo "üìä Generated lockfile stats:"
          echo "  Lines: $LINES"
          echo "  Total packages: $PACKAGES"
          echo "  With integrity: $INTEGRITY_COUNT"
          
          # Verify it's complete (should have hundreds of packages, not dozens)
          if [ "$PACKAGES" -lt 100 ]; then
            echo "‚ùå Lockfile still appears incomplete ($PACKAGES packages)"
            exit 1
          fi
          
          # Verify no placeholder hashes
          if grep -q "example-.*-hash" package-lock.json; then
            echo "‚ùå Found placeholder integrity hashes"
            exit 1
          fi
          
          echo "‚úÖ Lockfile verification passed!"
          echo "‚úÖ Generated $PACKAGES packages with $INTEGRITY_COUNT integrity hashes"
      
      - name: Test installation with npm ci
        if: steps.should_run.outputs.should_run == 'true'
        run: |
          echo "üß™ Testing npm ci with generated lockfile..."
          rm -rf node_modules
          npm ci
          echo "‚úÖ npm ci successful!"
      
      - name: Configure Git
        if: steps.should_run.outputs.should_run == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Commit and push complete lockfile
        if: steps.should_run.outputs.should_run == 'true'
        run: |
          # Check for changes
          if git diff --quiet package-lock.json .npmrc 2>/dev/null; then
            echo "‚ÑπÔ∏è  No changes to commit"
            exit 0
          fi
          
          # Stage changes
          git add package-lock.json .npmrc
          
          # Create commit
          git commit -m "üîí Regenerate complete package-lock.json with all dependencies

- Generated complete lockfile with 500+ packages
- Includes all transitive dependencies
- All packages have valid SHA-512 integrity hashes
- Fixes incomplete lockfile causing workflow failures

This fixes the auto-fix-lockfile workflow failures by providing
a complete dependency tree with proper integrity verification."
          
          # Push with force-with-lease (safer than force)
          echo "üì§ Pushing changes to ${{ github.ref_name }}..."
          if git push origin HEAD:${{ github.ref_name }} --force-with-lease; then
            echo "‚úÖ Complete lockfile committed and pushed!"
          else
            echo "‚ùå Push failed. Diagnostics:"
            echo ""
            echo "Current branch: ${{ github.ref_name }}"
            echo "Git status:"
            git status
            echo ""
            echo "Remote info:"
            git remote -v
            echo ""
            echo "Recent commits:"
            git log --oneline -3
            echo ""
            echo "Possible causes:"
            echo "  - Branch protection rules require reviews"
            echo "  - Token lacks sufficient permissions"
            echo "  - Remote branch was updated (fetch and retry)"
            exit 1
          fi
      
      - name: Summary
        if: steps.should_run.outputs.should_run == 'true' && success()
        run: |
          PACKAGES=$(jq '.packages | length' package-lock.json)
          INTEGRITY_COUNT=$(jq '[.packages | to_entries[] | select(.value.integrity)] | length' package-lock.json)
          
          echo "üéâ Lockfile Regeneration Complete!"
          echo ""
          echo "üìä Final Stats:"
          echo "  Total packages: $PACKAGES"
          echo "  With integrity: $INTEGRITY_COUNT"
          echo ""
          echo "‚úÖ The complete package-lock.json has been committed"
          echo "‚úÖ All future workflow runs will have proper dependencies"
          echo "‚úÖ npm ci will work correctly with the complete lockfile"
