name: Regenerate Complete Lockfile

on:
  workflow_dispatch:
    inputs:
      force:
        description: 'Force regeneration even if lockfile exists'
        required: false
        default: true
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  regenerate:
    runs-on: ubuntu-latest
    name: Regenerate package-lock.json
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
      
      - name: Configure Git
        shell: bash
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          echo "‚úÖ Git configured"
      
      - name: Check npm registry connectivity
        shell: bash
        run: |
          echo "=== Checking npm registry connectivity ==="
          npm config set registry https://registry.npmjs.org/
          npm ping || echo "‚ö†Ô∏è  npm registry ping failed, but continuing..."
          echo "npm version: $(npm --version)"
          echo "node version: $(node --version)"
      
      - name: Remove incomplete lockfile
        shell: bash
        run: |
          echo "=== Removing incomplete lockfile ==="
          if [ -f package-lock.json ]; then
            echo "Found existing package-lock.json"
            
            # Check for placeholder hashes
            if grep -q "example-integrity-hash\|example-.*-hash" package-lock.json; then
              echo "‚ö†Ô∏è  Found placeholder integrity hashes - lockfile is invalid"
              PLACEHOLDER_COUNT=$(grep -c "example-.*-hash" package-lock.json || echo "0")
              echo "Found $PLACEHOLDER_COUNT placeholder hashes"
            fi
            
            rm package-lock.json
            echo "‚úÖ Removed incomplete lockfile"
          else
            echo "No existing lockfile found"
          fi
          
          # Also clean npm cache to ensure fresh download
          echo "Cleaning npm cache..."
          npm cache clean --force || true
      
      - name: Generate complete package-lock.json
        shell: bash
        run: |
          echo "=== Generating Complete Lockfile ==="
          echo "This will download and verify all dependencies..."
          
          # Set npm config for better reliability
          npm config set fetch-retries 5
          npm config set fetch-retry-mintimeout 20000
          npm config set fetch-retry-maxtimeout 120000
          
          # Use npm install to generate a complete lockfile
          echo "Running: npm install --package-lock-only"
          if ! npm install --package-lock-only; then
            echo "‚ùå npm install failed. Showing npm debug info:"
            npm config list
            echo ""
            echo "Package.json content:"
            cat package.json
            exit 1
          fi
          
          if [ -f package-lock.json ]; then
            LOCKFILE_LINES=$(wc -l < package-lock.json)
            echo "‚úÖ Generated package-lock.json with $LOCKFILE_LINES lines"
            
            # Verify it has proper integrity hashes (not placeholders)
            if grep -q "example-integrity-hash\|example-.*-hash" package-lock.json; then
              echo "‚ùå ERROR: Generated lockfile still contains placeholder hashes!"
              echo "This should not happen. Showing problematic entries:"
              grep -n "example-.*-hash" package-lock.json | head -10
              exit 1
            fi
            
            # Verify it has real integrity hashes
            if grep -q '"integrity": "sha' package-lock.json; then
              INTEGRITY_COUNT=$(grep -c '"integrity": "sha' package-lock.json || echo "0")
              echo "‚úÖ Lockfile contains $INTEGRITY_COUNT proper integrity hashes"
            else
              echo "‚ö†Ô∏è  Warning: No integrity hashes found"
            fi
          else
            echo "‚ùå Failed to generate lockfile"
            exit 1
          fi
      
      - name: Verify lockfile
        shell: bash
        run: |
          echo "=== Verifying Lockfile ==="
          
          # Check if lockfile is valid
          if npm ls --package-lock-only 2>&1 | grep -q 'npm ERR!'; then
            echo "‚ö†Ô∏è  Warning: Some dependency issues detected"
            npm ls --package-lock-only || true
          else
            echo "‚úÖ Lockfile is valid"
          fi
          
          echo ""
          echo "=== Lockfile Statistics ==="
          echo "Total lines: $(wc -l < package-lock.json)"
          echo "Total packages: $(grep -c '"resolved":' package-lock.json || echo '0')"
          echo "File size: $(du -h package-lock.json | cut -f1)"
      
      - name: Commit and push changes
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== Committing Changes ==="
          
          git add package-lock.json
          
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è  No changes to commit - lockfile already up to date"
            exit 0
          fi
          
          # Show what changed
          echo "Files to be committed:"
          git diff --staged --stat
          
          # Commit with [skip ci] to prevent triggering other workflows
          git commit -m "üîß Regenerate complete package-lock.json [skip ci]

This fixes the incomplete lockfile that was causing deployment issues.

Changes:
- Complete dependency resolution with all transitive dependencies
- Proper integrity hashes for all packages (no placeholders)
- Verified lockfile format

Fixes workflow failures and enables proper dependency caching."
          
          echo "=== Pushing Changes ==="
          
          # Pull latest changes first to avoid conflicts
          git pull --rebase origin fix-complete-lockfile-integrity || {
            echo "‚ö†Ô∏è  Pull failed, but continuing with push..."
          }
          
          # Push with retry logic
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Push attempt $((RETRY_COUNT + 1)) of $MAX_RETRIES"
            
            if git push origin HEAD:fix-complete-lockfile-integrity 2>&1; then
              echo "‚úÖ Changes successfully pushed to fix-complete-lockfile-integrity"
              exit 0
            else
              PUSH_EXIT_CODE=$?
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "‚ö†Ô∏è  Push attempt $RETRY_COUNT failed with exit code $PUSH_EXIT_CODE"
              
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "Retrying in 5 seconds..."
                sleep 5
                git pull --rebase origin fix-complete-lockfile-integrity || true
              fi
            fi
          done
          
          echo "‚ùå Failed to push after $MAX_RETRIES attempts"
          echo "This might be due to:"
          echo "  1. Branch protection rules preventing bot pushes"
          echo "  2. Insufficient workflow permissions"
          echo "  3. Network connectivity issues"
          echo ""
          echo "To fix, check repository Settings > Actions > General > Workflow permissions"
          echo "Ensure 'Read and write permissions' is selected"
          exit 1
