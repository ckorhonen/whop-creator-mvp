name: Regenerate Complete Lockfile

on:
  workflow_dispatch:
    inputs:
      force:
        description: 'Force regeneration even if lockfile exists'
        required: false
        default: 'true'

permissions:
  contents: write
  pull-requests: write
  actions: write

jobs:
  regenerate:
    runs-on: ubuntu-latest
    name: Regenerate package-lock.json
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          ref: ${{ github.ref }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          # Disable cache to ensure fresh package metadata
          # cache: 'npm'
      
      - name: Configure Git
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          echo "‚úÖ Git configured"
          echo "üìç Current branch: $(git branch --show-current)"
          echo "üìç Current ref: ${{ github.ref }}"
      
      - name: Analyze current lockfile
        id: analyze
        run: |
          echo "=== Analyzing Lockfile ===="
          
          if [ ! -f package-lock.json ]; then
            echo "status=missing" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  No lockfile found"
            exit 0
          fi
          
          # Check for placeholder hashes
          PLACEHOLDER_COUNT=$(grep -c "example-.*-hash" package-lock.json 2>/dev/null || echo "0")
          
          if [ "$PLACEHOLDER_COUNT" -gt "0" ]; then
            echo "status=invalid" >> $GITHUB_OUTPUT
            echo "placeholder_count=$PLACEHOLDER_COUNT" >> $GITHUB_OUTPUT
            echo "‚ùå Found $PLACEHOLDER_COUNT placeholder integrity hashes"
            
            echo ""
            echo "Examples of placeholder hashes found:"
            grep "example-.*-hash" package-lock.json | head -5
          else
            echo "status=valid" >> $GITHUB_OUTPUT
            echo "‚úÖ Lockfile appears valid (no placeholders)"
          fi
      
      - name: Clear caches and prepare for regeneration
        if: steps.analyze.outputs.status != 'valid' || github.event.inputs.force == 'true'
        run: |
          echo "=== Clearing Caches ===="
          
          # Remove node_modules if it exists
          if [ -d node_modules ]; then
            rm -rf node_modules
            echo "‚úÖ Removed node_modules"
          fi
          
          # Clear npm cache to ensure fresh downloads
          npm cache clean --force
          echo "‚úÖ Cleared npm cache"
          
          # Remove existing lockfile
          if [ -f package-lock.json ]; then
            rm package-lock.json
            echo "‚úÖ Removed old lockfile"
          fi
      
      - name: Regenerate lockfile
        if: steps.analyze.outputs.status != 'valid' || github.event.inputs.force == 'true'
        run: |
          echo "=== Regenerating Lockfile ===="
          echo ""
          echo "Running: npm install --package-lock-only --loglevel=verbose"
          echo "This will fetch fresh package metadata and generate proper integrity hashes..."
          echo ""
          
          # Regenerate with verbose logging for debugging
          npm install --package-lock-only --loglevel=verbose
          
          if [ ! -f package-lock.json ]; then
            echo "‚ùå ERROR: Failed to generate lockfile"
            exit 1
          fi
          
          echo ""
          echo "‚úÖ New lockfile generated"
      
      - name: Verify new lockfile
        if: steps.analyze.outputs.status != 'valid' || github.event.inputs.force == 'true'
        run: |
          echo "=== Verifying New Lockfile ===="
          
          # Check for remaining placeholders
          REMAINING=$(grep -c "example-.*-hash" package-lock.json 2>/dev/null || echo "0")
          
          if [ "$REMAINING" -gt "0" ]; then
            echo "‚ùå ERROR: Generated lockfile still has $REMAINING placeholders!"
            echo "This indicates a serious issue with npm or the registry."
            grep -n "example-.*-hash" package-lock.json | head -10
            exit 1
          fi
          
          # Count real integrity hashes
          REAL_HASHES=$(grep -c '"integrity": "sha' package-lock.json 2>/dev/null || echo "0")
          
          if [ "$REAL_HASHES" -eq "0" ]; then
            echo "‚ùå ERROR: No integrity hashes found in lockfile"
            exit 1
          fi
          
          echo "‚úÖ Verification passed!"
          echo ""
          echo "=== Lockfile Statistics ===="
          echo "üìä Total lines: $(wc -l < package-lock.json)"
          echo "üì¶ Packages with integrity: $REAL_HASHES"
          echo "üì¶ Packages with resolved: $(grep -c '"resolved":' package-lock.json 2>/dev/null || echo '0')"
          echo "üíæ File size: $(du -h package-lock.json | cut -f1)"
      
      - name: Check for changes
        id: check_changes
        if: steps.analyze.outputs.status != 'valid' || github.event.inputs.force == 'true'
        run: |
          if git diff --quiet package-lock.json 2>/dev/null && git diff --cached --quiet package-lock.json 2>/dev/null; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  No changes detected in lockfile"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Changes detected in lockfile"
          fi
      
      - name: Commit and push changes
        if: (steps.analyze.outputs.status != 'valid' || github.event.inputs.force == 'true') && steps.check_changes.outputs.has_changes == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== Committing Changes ===="
          
          git add package-lock.json
          
          PLACEHOLDER_COUNT="${{ steps.analyze.outputs.placeholder_count }}"
          PLACEHOLDER_COUNT="${PLACEHOLDER_COUNT:-0}"
          RESOLVED_COUNT=$(grep -c '"resolved":' package-lock.json 2>/dev/null || echo '0')
          
          git commit -m "üîß Regenerate package-lock.json with real integrity hashes

Fixed placeholder/example integrity hashes with real SHA-512 hashes.

Changes:
- Removed lockfile with placeholder hashes ($PLACEHOLDER_COUNT found)
- Cleared npm cache to ensure fresh package metadata
- Regenerated using npm install --package-lock-only
- Verified all packages now have proper integrity hashes
- Total packages: $RESOLVED_COUNT

This enables proper dependency verification and caching in CI/CD."
          
          echo ""
          echo "=== Pushing to GitHub ===="
          
          # Get current branch
          CURRENT_BRANCH=$(git branch --show-current)
          echo "üìç Branch: $CURRENT_BRANCH"
          
          # Configure git remote to use token authentication
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          echo "‚úÖ Remote URL configured with token"
          
          # Attempt to push with force-with-lease first (safer)
          echo "Attempting push with --force-with-lease..."
          if git push origin "HEAD:${CURRENT_BRANCH}" --force-with-lease; then
            echo "‚úÖ Successfully pushed changes with force-with-lease!"
            exit 0
          fi
          
          # Fallback to simple push
          echo "‚ö†Ô∏è  force-with-lease failed, trying simple push..."
          if git push origin "HEAD:${CURRENT_BRANCH}"; then
            echo "‚úÖ Successfully pushed changes with simple push!"
            exit 0
          fi
          
          # If both fail, show diagnostics
          echo "‚ùå ERROR: Both push attempts failed"
          echo ""
          echo "=== Diagnostic Information ==="
          echo "Repository: ${GITHUB_REPOSITORY}"
          echo "Branch: ${CURRENT_BRANCH}"
          echo ""
          echo "Git status:"
          git status
          echo ""
          echo "Git log (last commit):"
          git log -1
          echo ""
          echo "Remote branches:"
          git branch -r
          exit 1
      
      - name: Summary
        if: always()
        run: |
          echo ""
          echo "==================================="
          echo "üìã Workflow Summary"
          echo "==================================="
          echo "Branch: ${{ github.ref_name }}"
          echo "Status: ${{ steps.analyze.outputs.status }}"
          
          if [ -f package-lock.json ]; then
            REAL_HASHES=$(grep -c '"integrity": "sha' package-lock.json 2>/dev/null || echo "0")
            PLACEHOLDERS=$(grep -c "example-.*-hash" package-lock.json 2>/dev/null || echo "0")
            
            if [ "$PLACEHOLDERS" -eq "0" ] && [ "$REAL_HASHES" -gt "0" ]; then
              echo "Result: ‚úÖ SUCCESS - Lockfile is now valid"
            else
              echo "Result: ‚ùå FAILED - Lockfile still has issues"
              echo "Placeholders: $PLACEHOLDERS"
              echo "Real hashes: $REAL_HASHES"
            fi
          else
            echo "Result: ‚ùå FAILED - No lockfile found"
          fi
