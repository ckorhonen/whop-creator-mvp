name: Fix Lockfile Now

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for lockfile fix (optional)'
        required: false
        default: 'Manual lockfile regeneration'

jobs:
  fix-lockfile:
    name: Generate Complete Lockfile
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install jq
        run: |
          echo "üì¶ Installing jq for JSON processing..."
          sudo apt-get update -qq
          sudo apt-get install -y jq
          echo "‚úÖ jq installed successfully"
          
      - name: Clean npm state
        run: |
          echo "üßπ Cleaning npm cache and node_modules..."
          rm -rf node_modules package-lock.json
          npm cache clean --force
          
      - name: Validate package.json
        run: |
          echo "üìã Validating package.json..."
          if [ ! -f "package.json" ]; then
            echo "‚ùå package.json not found!"
            exit 1
          fi
          
          # Check if package.json is valid JSON
          if ! jq empty package.json 2>/dev/null; then
            echo "‚ùå package.json is not valid JSON!"
            exit 1
          fi
          
          echo "‚úÖ package.json is valid"
          
      - name: Generate complete lockfile
        run: |
          echo "üî® Generating complete package-lock.json..."
          npm install --package-lock-only
          
          if [ ! -f "package-lock.json" ]; then
            echo "‚ùå Failed to generate package-lock.json"
            exit 1
          fi
          
          echo "‚úÖ package-lock.json generated successfully"
          
      - name: Verify lockfile completeness
        run: |
          echo "üîç Verifying lockfile..."
          
          # Count packages in lockfile
          PACKAGE_COUNT=$(jq '.packages | length' package-lock.json)
          echo "üì¶ Total packages in lockfile: $PACKAGE_COUNT"
          
          if [ "$PACKAGE_COUNT" -lt 50 ]; then
            echo "‚ö†Ô∏è  Warning: Lockfile seems incomplete (only $PACKAGE_COUNT packages)"
          fi
          
          # Check lockfile size
          LOCKFILE_SIZE=$(wc -c < package-lock.json)
          echo "üìè Lockfile size: $LOCKFILE_SIZE bytes"
          
          if [ "$LOCKFILE_SIZE" -lt 1000 ]; then
            echo "‚ùå Lockfile is too small, likely incomplete"
            exit 1
          fi
          
          echo "‚úÖ Lockfile appears complete"
          
      - name: Test installation with lockfile
        run: |
          echo "üß™ Testing npm ci with new lockfile..."
          rm -rf node_modules
          npm ci
          echo "‚úÖ npm ci successful"
          
      - name: Generate fix summary
        id: summary
        run: |
          echo "üìä Generating fix summary..."
          
          PACKAGE_COUNT=$(jq '.packages | length' package-lock.json)
          LOCKFILE_SIZE=$(wc -c < package-lock.json)
          REASON="${{ github.event.inputs.reason }}"
          
          cat > fix-summary.md << EOF
          # Lockfile Fix Summary
          
          ## Changes Made
          - ‚úÖ Generated complete package-lock.json
          - üì¶ Locked ${PACKAGE_COUNT} packages
          - üìè Lockfile size: ${LOCKFILE_SIZE} bytes
          
          ## What This Fixes
          - ‚úÖ Enables npm ci for faster, reproducible builds
          - ‚úÖ Locks all dependencies to specific versions
          - ‚úÖ Enables npm caching in CI (2-3x faster builds)
          - ‚úÖ Prevents dependency resolution conflicts
          - ‚úÖ Ensures consistent builds across environments
          
          ## Reason
          ${REASON}
          
          ## Next Steps
          1. Review the changes in this PR
          2. Merge to enable faster, more reliable builds
          3. Update deploy.yml to use npm ci and caching
          
          ---
          *Generated automatically by fix-lockfile-now workflow*
          EOF
          
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            Fix: Generate complete package-lock.json
            
            Generated complete lockfile to resolve dependency issues:
            - Enables npm ci for faster builds (15-20s vs 60-90s)
            - Locks all dependencies to specific versions
            - Enables npm caching in CI workflows
            - Prevents version conflicts and build failures
            
            Reason: ${{ github.event.inputs.reason }}
          branch: fix-lockfile-${{ github.run_number }}
          delete-branch: true
          title: "üîß Fix: Generate complete package-lock.json"
          body-path: fix-summary.md
          labels: |
            dependencies
            automated
          assignees: ${{ github.actor }}
          
      - name: Workflow completion
        run: |
          echo "üéâ Lockfile fix workflow completed successfully!"
          echo ""
          echo "Summary:"
          cat fix-summary.md
