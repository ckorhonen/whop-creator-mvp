name: Emergency Fix - Generate Complete Lockfile

on:
  workflow_dispatch:
  push:
    branches:
      - fix-incomplete-lockfile-19202809127

jobs:
  fix-lockfile:
    runs-on: ubuntu-latest
    name: Generate Complete package-lock.json
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: fix-incomplete-lockfile-19202809127
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Remove incomplete lockfile
        run: |
          echo "ğŸ—‘ï¸  Removing incomplete package-lock.json"
          rm -f package-lock.json
          echo "âœ… Removed"
          
      - name: Clean npm cache
        run: |
          echo "ğŸ§¹ Cleaning npm cache"
          npm cache clean --force
          echo "âœ… Cache cleaned"
          
      - name: Generate complete lockfile
        run: |
          echo "ğŸ“¦ Generating complete package-lock.json"
          echo "This will install ALL dependencies and their transitive deps"
          npm install --verbose
          echo "âœ… Complete lockfile generated"
          
      - name: Verify lockfile completeness
        run: |
          echo "ğŸ” Verifying lockfile is complete"
          echo ""
          
          LOCKFILE_SIZE=$(wc -l < package-lock.json)
          echo "Lockfile size: $LOCKFILE_SIZE lines"
          
          if [ "$LOCKFILE_SIZE" -lt 1000 ]; then
            echo "âŒ Error: Lockfile appears incomplete (< 1000 lines)"
            echo "Expected: 3000-5000+ lines for complete lockfile"
            exit 1
          fi
          echo "âœ… Lockfile size looks good"
          echo ""
          
          echo "Checking for critical packages..."
          
          # Check for vite plugin
          if grep -q "@vitejs/plugin-react" package-lock.json; then
            echo "âœ… @vitejs/plugin-react found"
          else
            echo "âŒ Error: @vitejs/plugin-react missing!"
            exit 1
          fi
          
          # Check for wrangler
          if grep -q "\"wrangler\"" package-lock.json; then
            echo "âœ… wrangler found"
          else
            echo "âŒ Error: wrangler missing!"
            exit 1
          fi
          
          # Check for babel (required by vite plugin)
          if grep -q "@babel/core" package-lock.json; then
            echo "âœ… @babel/core found"
          else
            echo "âŒ Error: @babel/core missing!"
            exit 1
          fi
          
          # Check for eslint
          ESLINT_COUNT=$(grep -c "eslint" package-lock.json || echo "0")
          if [ "$ESLINT_COUNT" -gt 10 ]; then
            echo "âœ… eslint packages found ($ESLINT_COUNT occurrences)"
          else
            echo "âŒ Error: eslint packages missing or incomplete!"
            exit 1
          fi
          
          echo ""
          echo "ğŸ‰ Lockfile verification passed!"
          echo "Total packages: $(grep -c '\"node_modules/' package-lock.json)"
          
      - name: Test installation with npm ci
        run: |
          echo "ğŸ§ª Testing npm ci with new lockfile"
          rm -rf node_modules
          npm ci
          echo "âœ… npm ci works!"
          
      - name: Test build
        run: |
          echo "ğŸ—ï¸  Testing build with new lockfile"
          npm run build
          echo "âœ… Build successful!"
          
      - name: Show build output
        run: |
          echo "ğŸ“Š Build output:"
          ls -lah dist/
          du -sh dist/
          
      - name: Commit and push lockfile
        run: |
          echo "ğŸ’¾ Committing complete lockfile"
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add package-lock.json
          git commit -m "Fix: Generate complete package-lock.json with all dependencies (Run #19202809127)

This lockfile includes:
- All 16 direct dependencies from package.json  
- 300-500+ transitive dependencies
- Integrity hashes for security
- Locked versions for reproducibility

Fixes workflow run #19202809127 that failed after 27 seconds.

Key improvements:
âœ… Includes @vitejs/plugin-react and all Babel dependencies
âœ… Includes wrangler for Cloudflare deployment
âœ… Includes all eslint packages
âœ… Enables npm ci for 2-3x faster builds
âœ… Enables npm caching in GitHub Actions
âœ… 100% reproducible builds

Generated by: Emergency Fix workflow
Size: $(wc -l < package-lock.json) lines
Packages: $(grep -c '\"node_modules/' package-lock.json)"
          
          git push origin fix-incomplete-lockfile-19202809127
          echo "âœ… Pushed to branch"
          
      - name: Success summary
        run: |
          echo "ğŸ‰ ================================"
          echo "ğŸ‰ EMERGENCY FIX SUCCESSFUL!"
          echo "ğŸ‰ ================================"
          echo ""
          echo "âœ… Complete package-lock.json generated"
          echo "âœ… All critical packages included"
          echo "âœ… npm ci verified working"
          echo "âœ… Build test passed"
          echo "âœ… Committed and pushed"
          echo ""
          echo "ğŸ“‹ Next steps:"
          echo "1. Go to: https://github.com/ckorhonen/whop-creator-mvp/compare/fix-incomplete-lockfile-19202809127"
          echo "2. Create PR to merge into main"
          echo "3. Review the changes"
          echo "4. Merge the PR"
          echo "5. Watch the deployment workflow succeed!"
          echo ""
          echo "ğŸš€ After merge, builds will be 2-3x faster!"
