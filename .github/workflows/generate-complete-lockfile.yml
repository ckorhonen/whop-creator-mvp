name: Generate Complete package-lock.json

on:
  workflow_dispatch:
    inputs:
      force_reinstall:
        description: 'Force reinstall all dependencies (clears node_modules)'
        required: false
        default: 'false'
        type: boolean

jobs:
  generate-complete-lockfile:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Validate Environment
        run: |
          echo "=== Environment Validation ==="
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"
          echo "Current directory: $(pwd)"
          echo ""
          
          echo "Checking for package.json..."
          if [ ! -f package.json ]; then
            echo "‚ùå Error: package.json not found"
            exit 1
          fi
          echo "‚úÖ package.json found"
          echo ""
          
          echo "Package.json contents:"
          cat package.json
          echo ""
          echo "=============================="
      
      - name: Check Existing Lockfile
        id: check_lockfile
        run: |
          echo "=== Checking Existing Lockfile ==="
          
          if [ -f package-lock.json ]; then
            LOCKFILE_SIZE=$(wc -l < package-lock.json)
            echo "üìÑ Found existing package-lock.json ($LOCKFILE_SIZE lines)"
            
            if [ "$LOCKFILE_SIZE" -gt 30 ]; then
              echo "‚úÖ Lockfile appears complete"
              echo "lockfile_exists=true" >> $GITHUB_OUTPUT
              echo "lockfile_complete=true" >> $GITHUB_OUTPUT
              echo "lockfile_size=$LOCKFILE_SIZE" >> $GITHUB_OUTPUT
            else
              echo "‚ö†Ô∏è  Lockfile appears incomplete (< 30 lines)"
              echo "Will regenerate complete lockfile"
              echo "lockfile_exists=true" >> $GITHUB_OUTPUT
              echo "lockfile_complete=false" >> $GITHUB_OUTPUT
              echo "lockfile_size=$LOCKFILE_SIZE" >> $GITHUB_OUTPUT
            fi
            
            echo ""
            echo "Current lockfile preview (first 20 lines):"
            head -n 20 package-lock.json
          else
            echo "‚ùå No package-lock.json found"
            echo "Will generate new complete lockfile"
            echo "lockfile_exists=false" >> $GITHUB_OUTPUT
            echo "lockfile_complete=false" >> $GITHUB_OUTPUT
            echo "lockfile_size=0" >> $GITHUB_OUTPUT
          fi
          
          echo ""
          echo "=============================="
      
      - name: Remove Incomplete Lockfile
        if: steps.check_lockfile.outputs.lockfile_complete == 'false' && steps.check_lockfile.outputs.lockfile_exists == 'true'
        run: |
          echo "=== Removing Incomplete Lockfile ==="
          echo "Removing existing incomplete package-lock.json..."
          rm -f package-lock.json
          echo "‚úÖ Incomplete lockfile removed"
          echo "=============================="
      
      - name: Clean Node Modules (if forced)
        if: inputs.force_reinstall == 'true'
        run: |
          echo "=== Cleaning Node Modules ==="
          echo "Force reinstall requested, cleaning node_modules..."
          rm -rf node_modules
          echo "‚úÖ node_modules cleaned"
          echo "=============================="
      
      - name: Generate Complete package-lock.json
        run: |
          echo "=== Generating Complete package-lock.json ==="
          echo "Starting npm install to generate complete lockfile..."
          echo ""
          
          # Set npm to use legacy peer deps to avoid conflicts
          if [ -f .npmrc ]; then
            echo "Using existing .npmrc configuration"
            cat .npmrc
          else
            echo "Setting legacy-peer-deps=true for compatibility"
            echo "legacy-peer-deps=true" > .npmrc
          fi
          echo ""
          
          # Clean npm cache for fresh start
          echo "Cleaning npm cache for fresh installation..."
          npm cache clean --force
          echo ""
          
          # Run npm install with retry logic
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "üì¶ Installing dependencies (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)..."
            
            if npm install --verbose 2>&1 | tee npm-install.log; then
              echo ""
              echo "‚úÖ npm install completed successfully"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo ""
                echo "‚ö†Ô∏è  npm install failed, retrying in 10 seconds..."
                echo "Error details:"
                tail -n 20 npm-install.log
                sleep 10
                
                echo "Cleaning npm cache before retry..."
                npm cache clean --force
              else
                echo ""
                echo "‚ùå npm install failed after $MAX_RETRIES attempts"
                echo ""
                echo "Full error log:"
                cat npm-install.log
                echo ""
                echo "üí° Troubleshooting:"
                echo "1. Check if all packages in package.json are available"
                echo "2. Verify npm registry connectivity"
                echo "3. Try running locally: npm install"
                exit 1
              fi
            fi
          done
          
          echo ""
          echo "=============================="
      
      - name: Verify Generated Lockfile
        run: |
          echo "=== Verifying Generated Lockfile ==="
          
          if [ ! -f package-lock.json ]; then
            echo "‚ùå Error: package-lock.json was not generated"
            echo "npm install may have failed"
            exit 1
          fi
          
          LOCKFILE_SIZE=$(wc -l < package-lock.json)
          echo "‚úÖ package-lock.json generated successfully"
          echo "üìä Lockfile size: $LOCKFILE_SIZE lines"
          
          if [ "$LOCKFILE_SIZE" -lt 30 ]; then
            echo "‚ùå Error: Generated lockfile appears incomplete (< 30 lines)"
            echo "This usually means npm install didn't complete properly"
            echo ""
            echo "Lockfile contents:"
            cat package-lock.json
            exit 1
          fi
          
          echo ""
          echo "üìÑ Lockfile preview (first 30 lines):"
          head -n 30 package-lock.json
          echo ""
          echo "... (total $LOCKFILE_SIZE lines)"
          echo ""
          
          # Verify lockfile structure
          echo "Verifying lockfile structure..."
          if ! node -e "const fs = require('fs'); const lock = JSON.parse(fs.readFileSync('package-lock.json')); if (!lock.packages || !lock.lockfileVersion) process.exit(1);"; then
            echo "‚ùå Error: Lockfile structure is invalid"
            exit 1
          fi
          
          echo "‚úÖ Lockfile structure is valid"
          echo ""
          echo "üì¶ Dependencies locked:"
          node -e "const fs = require('fs'); const lock = JSON.parse(fs.readFileSync('package-lock.json')); const packages = Object.keys(lock.packages || {}).length; console.log('  Total packages:', packages);"
          
          echo ""
          echo "=============================="
      
      - name: Verify Installation
        run: |
          echo "=== Verifying Installation ==="
          
          if [ ! -d node_modules ]; then
            echo "‚ùå Error: node_modules directory not found"
            exit 1
          fi
          
          echo "‚úÖ node_modules directory exists"
          echo ""
          echo "üìä Installation size:"
          du -sh node_modules/
          echo ""
          echo "üì¶ Installed packages:"
          ls -d node_modules/*/ 2>/dev/null | wc -l
          echo ""
          echo "=============================="
      
      - name: Test Build with Lockfile
        run: |
          echo "=== Testing Build with New Lockfile ==="
          echo "Running a test build to ensure lockfile works..."
          echo ""
          
          if npm run build; then
            echo ""
            echo "‚úÖ Test build succeeded with new lockfile"
          else
            echo ""
            echo "‚ùå Test build failed with new lockfile"
            echo "This suggests issues beyond the lockfile"
            echo "Continuing to create PR so you can investigate..."
          fi
          
          echo ""
          echo "=============================="
        continue-on-error: true
      
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'Add complete package-lock.json for reproducible builds'
          title: 'Add Complete package-lock.json'
          body: |
            ## üì¶ Add Complete package-lock.json
            
            This PR adds a **complete** `package-lock.json` file to enable:
            
            ### ‚ú® Benefits
            - üöÄ **Faster CI/CD builds** with npm caching (2-3x faster installs)
            - üîí **Reproducible builds** across all environments
            - ‚úÖ **Locked dependency versions** preventing unexpected updates
            - üõ°Ô∏è **Better security** with integrity hashes for all packages
            - üìä **Dependency tree tracking** for better debugging
            
            ### üìä Lockfile Details
            - **Size**: ${{ steps.check_lockfile.outputs.lockfile_size }} lines ‚Üí ~$LOCKFILE_SIZE lines
            - **Generated with**: Node.js 20.x, npm $(npm --version)
            - **Lockfile version**: 3 (npm 7+)
            
            ### üîß What Changed
            - Generated complete package-lock.json using `npm install`
            - All dependencies now have locked versions with integrity hashes
            - Transitive dependencies fully resolved
            
            ### ‚úÖ Verification
            - [x] Lockfile generated successfully
            - [x] Lockfile structure validated
            - [x] Test build attempted
            
            ### üöÄ Next Steps
            After merging this PR:
            1. Future workflows will use `npm ci` instead of `npm install`
            2. Builds will be 2-3x faster with npm caching enabled
            3. All environments will use identical dependency versions
            
            ### üìù Notes
            Generated automatically by the `generate-complete-lockfile.yml` workflow.
            
            ---
            
            **Generated**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
            **Workflow Run**: ${{ github.run_id }}
          branch: add-complete-package-lock-${{ github.run_id }}
          delete-branch: true
          labels: |
            dependencies
            automation
            enhancement
      
      - name: Workflow Summary
        if: always()
        run: |
          echo "=== Workflow Summary ==="
          echo "Completed at: $(date)"
          echo ""
          
          if [ -f package-lock.json ]; then
            FINAL_SIZE=$(wc -l < package-lock.json)
            echo "‚úÖ Complete package-lock.json generated"
            echo "üìä Final size: $FINAL_SIZE lines"
            echo ""
            echo "üéâ Success! A pull request has been created."
            echo "   Review and merge it to enable faster builds."
          else
            echo "‚ùå Workflow failed to generate complete lockfile"
            echo "   Check the logs above for error details"
          fi
          
          echo ""
          echo "=============================="
