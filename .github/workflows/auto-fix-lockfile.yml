name: Auto-Fix Package Lockfile

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for lockfile fix (optional)'
        required: false
        default: 'Auto-fix package-lock.json integrity issues'
  push:
    paths:
      - 'package.json'
      - 'package-lock.json'
    branches:
      - main
      - 'fix/**'

# Required permissions for workflow
permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  fix-complete-lockfile-integrity:
    name: Fix Complete Lockfile Integrity
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Debug workflow context
        run: |
          echo "üîç Workflow Debug Information"
          echo "Event: ${{ github.event_name }}"
          echo "Actor: ${{ github.actor }}"
          echo "Repository: ${{ github.repository }}"
          echo "Ref: ${{ github.ref }}"
          echo "SHA: ${{ github.sha }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Run Number: ${{ github.run_number }}"
      
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install jq for JSON processing
        run: |
          echo "üì¶ Installing jq for JSON processing..."
          sudo apt-get update -qq
          sudo apt-get install -y jq
          echo "‚úÖ jq installed successfully"
      
      - name: Validate package.json
        run: |
          echo "üìã Validating package.json..."
          
          if [ ! -f "package.json" ]; then
            echo "‚ùå package.json not found!"
            exit 1
          fi
          
          # Check if package.json is valid JSON
          if ! jq empty package.json 2>/dev/null; then
            echo "‚ùå package.json is not valid JSON!"
            exit 1
          fi
          
          echo "‚úÖ package.json is valid"
      
      - name: Check lockfile status
        id: check
        run: |
          echo "üîç Checking package-lock.json status..."
          
          NEEDS_FIX=false
          
          # Check if lockfile exists
          if [ ! -f "package-lock.json" ]; then
            echo "‚ö†Ô∏è  package-lock.json not found"
            NEEDS_FIX=true
          else
            # Check file size (incomplete if < 100 lines)
            LINE_COUNT=$(wc -l < package-lock.json)
            echo "üìä Current lockfile size: $LINE_COUNT lines"
            
            if [ "$LINE_COUNT" -lt 100 ]; then
              echo "‚ö†Ô∏è  Lockfile appears incomplete (< 100 lines)"
              NEEDS_FIX=true
            fi
            
            # Check for placeholder integrity hashes
            if grep -q "example-integrity-hash\|example-.*-hash\|PLACEHOLDER" package-lock.json 2>/dev/null; then
              echo "‚ùå Found placeholder integrity hashes"
              NEEDS_FIX=true
            fi
            
            # Check for missing integrity fields
            if ! grep -q '"integrity":' package-lock.json 2>/dev/null; then
              echo "‚ö†Ô∏è  No integrity hashes found in lockfile"
              NEEDS_FIX=true
            fi
          fi
          
          if [ "$NEEDS_FIX" = true ]; then
            echo "needs_fix=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  Lockfile needs repair"
          else
            echo "needs_fix=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Lockfile appears healthy"
          fi
      
      - name: Backup existing lockfile
        if: steps.check.outputs.needs_fix == 'true'
        run: |
          if [ -f "package-lock.json" ]; then
            echo "üíæ Backing up existing package-lock.json..."
            cp package-lock.json package-lock.json.backup
            echo "‚úÖ Backup created"
          fi
      
      - name: Clean npm state
        if: steps.check.outputs.needs_fix == 'true'
        run: |
          echo "üßπ Cleaning npm cache and node_modules..."
          rm -rf node_modules
          rm -f package-lock.json
          npm cache clean --force
          echo "‚úÖ Clean state achieved"
      
      - name: Configure npm
        if: steps.check.outputs.needs_fix == 'true'
        run: |
          echo "‚öôÔ∏è  Configuring npm..."
          
          # Use legacy-peer-deps for compatibility
          if [ ! -f ".npmrc" ]; then
            echo "legacy-peer-deps=true" > .npmrc
            echo "‚úÖ Created .npmrc with legacy-peer-deps"
          else
            echo "üìÑ Using existing .npmrc"
            cat .npmrc
          fi
      
      - name: Generate complete lockfile
        if: steps.check.outputs.needs_fix == 'true'
        run: |
          echo "üî® Generating complete package-lock.json..."
          
          # Install with retry logic
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "üì¶ Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES: Running npm install..."
            
            if npm install --verbose 2>&1 | tee npm-install.log; then
              echo "‚úÖ npm install completed successfully"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "‚ö†Ô∏è  npm install failed, retrying in 10 seconds..."
                sleep 10
                npm cache clean --force
              else
                echo "‚ùå npm install failed after $MAX_RETRIES attempts"
                echo "Last error:"
                tail -n 50 npm-install.log
                exit 1
              fi
            fi
          done
      
      - name: Verify generated lockfile
        if: steps.check.outputs.needs_fix == 'true'
        run: |
          echo "üîç Verifying generated lockfile..."
          
          if [ ! -f "package-lock.json" ]; then
            echo "‚ùå package-lock.json was not generated"
            exit 1
          fi
          
          LINE_COUNT=$(wc -l < package-lock.json)
          echo "üìä Generated lockfile size: $LINE_COUNT lines"
          
          if [ "$LINE_COUNT" -lt 100 ]; then
            echo "‚ùå Generated lockfile appears incomplete"
            exit 1
          fi
          
          # Verify no placeholder hashes
          if grep -q "example-integrity-hash\|example-.*-hash\|PLACEHOLDER" package-lock.json; then
            echo "‚ùå Placeholder hashes still present"
            exit 1
          fi
          
          # Verify structure
          if ! node -e "const fs = require('fs'); const lock = JSON.parse(fs.readFileSync('package-lock.json')); if (!lock.packages || !lock.lockfileVersion) process.exit(1);"; then
            echo "‚ùå Lockfile structure is invalid"
            exit 1
          fi
          
          # Count packages with integrity
          INTEGRITY_COUNT=$(jq '[.packages | to_entries[] | select(.value.integrity)] | length' package-lock.json)
          TOTAL_PACKAGES=$(jq '.packages | length' package-lock.json)
          
          echo "‚úÖ Lockfile verification passed"
          echo "   Total packages: $TOTAL_PACKAGES"
          echo "   With integrity: $INTEGRITY_COUNT"
      
      - name: Test installation
        if: steps.check.outputs.needs_fix == 'true'
        run: |
          echo "üß™ Testing npm ci with fixed lockfile..."
          rm -rf node_modules
          
          if npm ci; then
            echo "‚úÖ npm ci successful"
          else
            echo "‚ö†Ô∏è  npm ci failed, but lockfile was generated"
            echo "This may indicate other issues to investigate"
          fi
        continue-on-error: true
      
      - name: Generate fix summary
        if: steps.check.outputs.needs_fix == 'true'
        run: |
          echo "üìä Generating fix summary..."
          
          TOTAL_PACKAGES=$(jq '.packages | length' package-lock.json)
          INTEGRITY_COUNT=$(jq '[.packages | to_entries[] | select(.value.integrity)] | length' package-lock.json)
          REASON="${{ github.event.inputs.reason }}"
          
          # Create summary using echo to avoid heredoc issues
          {
            echo "# üîí Lockfile Integrity Fix Summary"
            echo ""
            echo "## Problem Detected"
            echo "- ‚ùå Package-lock.json was missing, incomplete, or had invalid integrity hashes"
            echo "- ‚ùå This prevents proper dependency verification and reproducible builds"
            echo "- ‚ùå Causes security vulnerabilities and build inconsistencies"
            echo ""
            echo "## Changes Made"
            echo "- ‚úÖ Regenerated complete package-lock.json with valid integrity hashes"
            echo "- üì¶ Fixed integrity for $INTEGRITY_COUNT out of $TOTAL_PACKAGES packages"
            echo "- üîí Enabled proper dependency verification and security scanning"
            echo ""
            echo "## Benefits"
            echo "- ‚úÖ **Security**: Packages are now verified against their checksums"
            echo "- ‚úÖ **Reproducibility**: Identical dependency trees across all environments"
            echo "- ‚úÖ **Performance**: Faster installs with npm ci instead of npm install"
            echo "- ‚úÖ **Reliability**: Prevents installation of tampered or corrupted packages"
            echo "- ‚úÖ **Compliance**: Follows npm security best practices"
            echo ""
            echo "## Technical Details"
            echo "- **Lockfile version**: 3 (npm 7+)"
            echo "- **Node.js version**: 20.x"
            echo "- **Total packages locked**: $TOTAL_PACKAGES"
            echo "- **Packages with integrity**: $INTEGRITY_COUNT"
            echo ""
            echo "## Reason"
            echo "${REASON:-Auto-generated fix}"
            echo ""
            echo "## Next Steps"
            echo "1. ‚úÖ Review the integrity hash changes"
            echo "2. ‚úÖ Merge this PR to enable proper dependency verification"
            echo "3. ‚úÖ All future installs will verify package integrity"
            echo "4. ‚úÖ Update CI/CD to use \`npm ci\` for faster, reproducible builds"
            echo ""
            echo "---"
            echo "*Generated automatically by auto-fix-lockfile workflow*"
          } > fix-summary.md
          
          echo "‚úÖ Summary generated"
          cat fix-summary.md
      
      - name: Create Pull Request
        if: steps.check.outputs.needs_fix == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            üîí Fix: Auto-regenerate complete package-lock.json with integrity
            
            - Regenerated lockfile with valid SHA-512 integrity hashes
            - Enables proper package verification and security scanning
            - Prevents installation of tampered dependencies
            - Ensures reproducible and secure builds
            
            Triggered by: ${{ github.event_name }}
            Reason: ${{ github.event.inputs.reason }}
          branch: auto-fix-lockfile-${{ github.run_number }}
          delete-branch: true
          title: "üîí Auto-fix: Regenerate complete package-lock.json with integrity"
          body-path: fix-summary.md
          labels: |
            security
            dependencies
            automated
            lockfile-fix
          assignees: ${{ github.actor }}
      
      - name: Workflow completion
        run: |
          echo "=== Workflow Completion ==="
          
          if [ "${{ steps.check.outputs.needs_fix }}" == "true" ]; then
            echo "üéâ Auto-fix workflow completed successfully!"
            echo ""
            echo "A pull request has been created with the fixed lockfile."
            echo "Review and merge it to enable secure, reproducible builds."
          else
            echo "‚úÖ No fixes needed - lockfile is already healthy!"
          fi
          
          echo "=========================="
