name: Auto-Fix Complete Lockfile

on:
  push:
    branches:
      - auto-fix-complete-lockfile
  workflow_dispatch:

permissions:
  contents: write

jobs:
  regenerate-lockfile:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Remove all existing artifacts
        run: |
          echo "üßπ Removing all existing build artifacts..."
          rm -rf package-lock.json node_modules
          echo "‚úÖ Cleanup complete"
          
      - name: Clean all caches
        run: |
          echo "üßπ Cleaning all caches..."
          npm cache clean --force
          # Also clear any yarn cache if it exists
          if command -v yarn &> /dev/null; then
            yarn cache clean
          fi
          echo "‚úÖ Cache cleaned"
          
      - name: Generate complete lockfile with force
        run: |
          echo "üì¶ Generating complete package-lock.json..."
          # Use --force to ensure npm rebuilds everything from scratch
          npm install --force --loglevel=verbose
          echo "‚úÖ Lockfile generated"
          
      - name: Verify lockfile completeness
        run: |
          if [ ! -f package-lock.json ]; then
            echo "‚ùå Error: package-lock.json was not created"
            exit 1
          fi
          
          LINES=$(wc -l < package-lock.json)
          SIZE=$(du -h package-lock.json | cut -f1)
          echo "üìä Lockfile stats:"
          echo "  - Lines: $LINES"
          echo "  - Size: $SIZE"
          
          # A complete lockfile for this project should have >1000 lines
          # The current incomplete one has only ~350 lines
          if [ "$LINES" -lt 1000 ]; then
            echo "‚ùå Error: Lockfile appears incomplete (< 1000 lines)"
            echo "Expected complete lockfile to include all nested dependencies for:"
            echo "  - @babel/* packages"
            echo "  - @typescript-eslint/*"  
            echo "  - eslint plugins"
            echo "  - vite and rollup dependencies"
            echo "  - wrangler dependencies"
            exit 1
          fi
          
          echo "‚úÖ Lockfile appears complete"
          
      - name: Test with npm ci
        run: |
          echo "üß™ Testing lockfile with npm ci..."
          rm -rf node_modules
          npm ci --loglevel=verbose
          echo "‚úÖ npm ci successful - lockfile is valid"
          
      - name: Check for changes
        id: git-check
        run: |
          git diff --exit-code package-lock.json || echo "changed=true" >> $GITHUB_OUTPUT
          
      - name: Commit and push changes
        if: steps.git-check.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package-lock.json
          git commit -m "fix: Generate complete package-lock.json with full dependency tree

This commit adds a complete package-lock.json file that includes:
- Full dependency trees for all @babel/* packages
- Complete @typescript-eslint/* dependencies
- All eslint and plugin dependencies with proper resolution
- Full dependency resolution for vite, rollup, and wrangler
- Proper integrity hashes for all packages and their transitive deps

Generated with npm install --force to ensure clean, complete resolution.
Tested with npm ci to verify integrity and completeness.

This resolves lockfile integrity issues and enables proper reproducible builds."
          git push
          echo "‚úÖ Changes committed and pushed"
      
      - name: No changes needed
        if: steps.git-check.outputs.changed != 'true'
        run: |
          echo "‚ÑπÔ∏è  No changes to commit - lockfile is already complete"
