name: Fix Lockfile Integrity

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for integrity fix (optional)'
        required: false
        default: 'Fix package-lock.json integrity hashes'
  push:
    branches:
      - '**'
    paths:
      - 'package.json'
      - '.github/workflows/fix-lockfile-integrity.yml'

# Required permissions for create-pull-request action
permissions:
  contents: write
  pull-requests: write
  actions: read
  metadata: read  # Required for workflow to access repository metadata

jobs:
  fix-integrity:
    name: Fix Package Lockfile Integrity
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Debug - Workflow context validation
        env:
          GH_REPOSITORY: ${{ github.repository }}
          GH_ACTOR: ${{ github.actor }}
          GH_EVENT_NAME: ${{ github.event_name }}
          GH_REF: ${{ github.ref }}
          GH_SHA: ${{ github.sha }}
          GH_RUN_ID: ${{ github.run_id }}
          GH_RUN_NUMBER: ${{ github.run_number }}
          GH_WORKFLOW: ${{ github.workflow }}
          GH_JOB: ${{ github.job }}
          RUNNER_OS: ${{ runner.os }}
          RUNNER_ARCH: ${{ runner.arch }}
        run: |
          echo "ðŸ” === Workflow Context Debug Information ==="
          echo "Repository: $GH_REPOSITORY"
          echo "Actor: $GH_ACTOR"
          echo "Event: $GH_EVENT_NAME"
          echo "Ref: $GH_REF"
          echo "SHA: $GH_SHA"
          echo "Run ID: $GH_RUN_ID"
          echo "Run Number: $GH_RUN_NUMBER"
          echo "Workflow: $GH_WORKFLOW"
          echo "Job: $GH_JOB"
          echo "Runner OS: $RUNNER_OS"
          echo "Runner Arch: $RUNNER_ARCH"
          echo "================================================"
          
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ github.token }}
          persist-credentials: true
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          # Note: npm cache is intentionally NOT enabled here because this workflow
          # is designed to fix broken/missing lockfiles. The cache setup requires
          # a valid package-lock.json which may not exist or be corrupted.
      
      - name: Install jq
        run: |
          echo "ðŸ“¦ Installing jq for JSON processing..."
          sudo apt-get update -qq
          sudo apt-get install -y jq
          echo "âœ… jq installed successfully"
          
      - name: Check for integrity issues
        id: check
        run: |
          echo "ðŸ” Checking for integrity issues in package-lock.json..."
          
          if [ ! -f "package-lock.json" ]; then
            echo "âš ï¸  package-lock.json not found"
            echo "has_issues=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check for example/placeholder integrity hashes
          if grep -q "example-integrity-hash\|example-.*-hash" package-lock.json; then
            echo "âŒ Found placeholder integrity hashes"
            echo "has_issues=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… No placeholder integrity hashes found"
            echo "has_issues=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Clean npm state
        if: steps.check.outputs.has_issues == 'true'
        run: |
          echo "ðŸ§¹ Cleaning npm cache and node_modules..."
          rm -rf node_modules package-lock.json
          npm cache clean --force
          
      - name: Validate package.json
        if: steps.check.outputs.has_issues == 'true'
        run: |
          echo "ðŸ“‹ Validating package.json..."
          if [ ! -f "package.json" ]; then
            echo "âŒ package.json not found!"
            exit 1
          fi
          
          # Check if package.json is valid JSON
          if ! jq empty package.json 2>/dev/null; then
            echo "âŒ package.json is not valid JSON!"
            exit 1
          fi
          
          echo "âœ… package.json is valid"
          
      - name: Regenerate lockfile with correct integrity
        if: steps.check.outputs.has_issues == 'true'
        run: |
          echo "ðŸ”¨ Regenerating package-lock.json with correct integrity hashes..."
          npm install --package-lock-only
          
          if [ ! -f "package-lock.json" ]; then
            echo "âŒ Failed to generate package-lock.json"
            exit 1
          fi
          
          echo "âœ… package-lock.json regenerated successfully"
          
      - name: Verify integrity hashes
        if: steps.check.outputs.has_issues == 'true'
        run: |
          echo "ðŸ” Verifying integrity hashes..."
          
          # Check that no placeholder hashes remain
          if grep -q "example-integrity-hash\|example-.*-hash" package-lock.json; then
            echo "âŒ Still found placeholder integrity hashes after regeneration!"
            exit 1
          fi
          
          # Count packages with integrity
          INTEGRITY_COUNT=$(jq '[.packages | to_entries[] | select(.value.integrity)] | length' package-lock.json)
          echo "âœ… Verified $INTEGRITY_COUNT packages with valid integrity hashes"
          
      - name: Test installation
        if: steps.check.outputs.has_issues == 'true'
        run: |
          echo "ðŸ§ª Testing npm ci with fixed lockfile..."
          rm -rf node_modules
          npm ci
          echo "âœ… npm ci successful with fixed lockfile"
          
      - name: Generate fix summary
        if: steps.check.outputs.has_issues == 'true'
        id: summary
        env:
          INPUT_REASON: ${{ github.event.inputs.reason }}
        run: |
          echo "ðŸ“Š Generating fix summary..."
          
          PACKAGE_COUNT=$(jq '.packages | length' package-lock.json)
          INTEGRITY_COUNT=$(jq '[.packages | to_entries[] | select(.value.integrity)] | length' package-lock.json)
          
          # Use environment variable instead of GitHub Actions expression
          REASON="${INPUT_REASON}"
          if [ -z "$REASON" ]; then
            REASON="Fix package-lock.json integrity hashes"
          fi
          
          cat > fix-summary.md <<'EOF'
# Lockfile Integrity Fix Summary

## Problem Detected
- âŒ Package-lock.json contained placeholder integrity hashes
- âŒ This prevents proper dependency verification
- âŒ Causes security and reproducibility issues

## Changes Made
- âœ… Regenerated package-lock.json with valid integrity hashes
- ðŸ“¦ Fixed integrity for INTEGRITY_COUNT_PLACEHOLDER out of PACKAGE_COUNT_PLACEHOLDER packages
- ðŸ”’ Enabled proper dependency verification

## What This Fixes
- âœ… Ensures packages are verified against their checksums
- âœ… Prevents tampered or corrupted packages
- âœ… Enables security scanning and audit tools
- âœ… Ensures reproducible builds
- âœ… Complies with npm security best practices

## Reason
REASON_PLACEHOLDER

## Next Steps
1. Review the integrity hash changes
2. Merge to enable proper dependency verification
3. All future installs will verify package integrity

---
*Generated automatically by fix-lockfile-integrity workflow*
EOF
          
          # Replace placeholders
          sed -i "s/INTEGRITY_COUNT_PLACEHOLDER/$INTEGRITY_COUNT/g" fix-summary.md
          sed -i "s/PACKAGE_COUNT_PLACEHOLDER/$PACKAGE_COUNT/g" fix-summary.md
          sed -i "s/REASON_PLACEHOLDER/$REASON/g" fix-summary.md
          
          echo "âœ… Summary generated:"
          cat fix-summary.md
          
      - name: Create Pull Request
        # Only create PR when manually dispatched, not on automatic push events
        if: steps.check.outputs.has_issues == 'true' && github.event_name == 'workflow_dispatch'
        uses: peter-evans/create-pull-request@v6
        id: create_pr
        continue-on-error: true
        with:
          token: ${{ github.token }}
          commit-message: "fix: Regenerate package-lock.json with correct integrity hashes\n\nFixed placeholder integrity hashes in package-lock.json:\n- Regenerated lockfile with valid SHA-512 integrity hashes\n- Enables proper package verification and security scanning\n- Prevents installation of tampered dependencies\n- Ensures reproducible and secure builds\n\nReason: ${{ github.event.inputs.reason || 'Fix package-lock.json integrity hashes' }}"
          branch: fix-lockfile-integrity-${{ github.run_number }}
          delete-branch: true
          title: "ðŸ”’ Fix: Regenerate package-lock.json with correct integrity hashes"
          body-path: fix-summary.md
          labels: |
            security
            dependencies
            automated
          assignees: ${{ github.actor }}
          
      - name: PR Creation Status
        if: steps.check.outputs.has_issues == 'true' && github.event_name == 'workflow_dispatch'
        env:
          PR_OUTCOME: ${{ steps.create_pr.outcome }}
          PR_NUMBER: ${{ steps.create_pr.outputs.pull-request-number }}
          PR_URL: ${{ steps.create_pr.outputs.pull-request-url }}
        run: |
          if [ "$PR_OUTCOME" == "success" ]; then
            echo "âœ… Pull request created successfully!"
            echo "PR Number: $PR_NUMBER"
            echo "PR URL: $PR_URL"
          else
            echo "âš ï¸  Could not create pull request automatically"
            echo "This may be due to permissions or existing PR"
            echo ""
            echo "Manual steps to apply fix:"
            echo "1. Review the changes in this workflow run"
            echo "2. Commit the regenerated package-lock.json manually"
            echo "3. Create a PR with the changes"
          fi
          
      - name: Report validation results (push events)
        if: github.event_name == 'push'
        env:
          HAS_ISSUES: ${{ steps.check.outputs.has_issues }}
        run: |
          if [ "$HAS_ISSUES" == "true" ]; then
            echo "âš ï¸  VALIDATION FAILED: Lockfile has integrity issues"
            echo ""
            echo "To fix these issues, manually trigger the workflow:"
            echo "  1. Go to Actions â†’ Fix Lockfile Integrity"
            echo "  2. Click 'Run workflow'"
            echo "  3. This will create a PR with the fixes"
            echo ""
            if [ -f "fix-summary.md" ]; then
              cat fix-summary.md
            fi
            exit 1
          else
            echo "âœ… VALIDATION PASSED: Lockfile integrity is healthy!"
            echo ""
            echo "ðŸ”’ All packages have valid integrity hashes"
            echo "âœ¨ Dependency verification is enabled"
            echo "ðŸŽ‰ No action needed - your lockfile is secure!"
          fi
          
      - name: Workflow completion
        if: github.event_name == 'workflow_dispatch'
        env:
          HAS_ISSUES: ${{ steps.check.outputs.has_issues }}
        run: |
          if [ "$HAS_ISSUES" == "true" ]; then
            echo "ðŸŽ‰ Lockfile integrity fix workflow completed successfully!"
            echo ""
            echo "Summary:"
            cat fix-summary.md
          else
            echo "âœ… No integrity issues found - lockfile is healthy!"
            echo ""
            echo "ðŸ”’ All packages have valid integrity hashes"
            echo "âœ¨ Dependency verification is enabled"
            echo "ðŸŽ‰ No action needed - your lockfile is secure!"
          fi
