name: Fix Lockfile Integrity

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for integrity fix (optional)'
        required: false
        default: 'Fix package-lock.json integrity hashes'
  push:
    paths:
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/fix-lockfile-integrity.yml'
    branches:
      - main

# Required permissions for create-pull-request action
permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  fix-integrity:
    name: Fix Package Lockfile Integrity
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    # Explicit permissions at job level (redundant but ensures they apply)
    permissions:
      contents: write
      pull-requests: write
      actions: read
    
    steps:
      - name: Debug - Check permissions
        run: |
          echo "ðŸ” Checking workflow permissions..."
          echo "Repository: ${{ github.repository }}"
          echo "Actor: ${{ github.actor }}"
          echo "Event: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          # Note: npm cache is intentionally NOT enabled here because this workflow
          # is designed to fix broken/missing lockfiles. The cache setup requires
          # a valid package-lock.json which may not exist or be corrupted.
      
      - name: Install jq
        run: |
          echo "ðŸ“¦ Installing jq for JSON processing..."
          sudo apt-get update -qq
          sudo apt-get install -y jq
          echo "âœ… jq installed successfully"
          
      - name: Check for integrity issues
        id: check
        run: |
          echo "ðŸ” Checking for integrity issues in package-lock.json..."
          
          if [ ! -f "package-lock.json" ]; then
            echo "âš ï¸  package-lock.json not found"
            echo "has_issues=true" >> $GITHUB_OUTPUT
            echo "issue_type=missing" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check if lockfile is incomplete (missing dependencies)
          PACKAGE_COUNT=$(jq '.packages | length' package-lock.json 2>/dev/null || echo "0")
          echo "ðŸ“Š Found $PACKAGE_COUNT packages in lockfile"
          
          if [ "$PACKAGE_COUNT" -lt "100" ]; then
            echo "âŒ Lockfile is incomplete (only $PACKAGE_COUNT packages, expected 100+)"
            echo "has_issues=true" >> $GITHUB_OUTPUT
            echo "issue_type=incomplete" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check for example/placeholder integrity hashes
          if grep -q "example-integrity-hash\|example-.*-hash" package-lock.json; then
            echo "âŒ Found placeholder integrity hashes"
            echo "has_issues=true" >> $GITHUB_OUTPUT
            echo "issue_type=placeholders" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "âœ… No integrity issues found"
          echo "has_issues=false" >> $GITHUB_OUTPUT
          
      - name: Clean npm state
        if: steps.check.outputs.has_issues == 'true'
        run: |
          echo "ðŸ§¹ Cleaning npm cache and node_modules..."
          rm -rf node_modules package-lock.json
          npm cache clean --force
          
      - name: Validate package.json
        if: steps.check.outputs.has_issues == 'true'
        run: |
          echo "ðŸ“‹ Validating package.json..."
          if [ ! -f "package.json" ]; then
            echo "âŒ package.json not found!"
            exit 1
          fi
          
          # Check if package.json is valid JSON
          if ! jq empty package.json 2>/dev/null; then
            echo "âŒ package.json is not valid JSON!"
            exit 1
          fi
          
          echo "âœ… package.json is valid"
          
      - name: Regenerate complete lockfile
        if: steps.check.outputs.has_issues == 'true'
        run: |
          echo "ðŸ”¨ Regenerating complete package-lock.json..."
          echo "Using 'npm install' to ensure ALL dependencies are resolved"
          
          # Use npm install (NOT --package-lock-only) to get complete dependency tree
          npm install
          
          if [ ! -f "package-lock.json" ]; then
            echo "âŒ Failed to generate package-lock.json"
            exit 1
          fi
          
          echo "âœ… package-lock.json regenerated successfully"
          
      - name: Verify lockfile completeness
        if: steps.check.outputs.has_issues == 'true'
        run: |
          echo "ðŸ” Verifying lockfile completeness..."
          
          # Check that no placeholder hashes remain
          if grep -q "example-integrity-hash\|example-.*-hash" package-lock.json; then
            echo "âŒ Still found placeholder integrity hashes after regeneration!"
            exit 1
          fi
          
          # Count packages with integrity
          PACKAGE_COUNT=$(jq '.packages | length' package-lock.json)
          INTEGRITY_COUNT=$(jq '[.packages | to_entries[] | select(.value.integrity)] | length' package-lock.json)
          
          echo "ðŸ“Š Package count: $PACKAGE_COUNT"
          echo "ðŸ“Š Packages with integrity: $INTEGRITY_COUNT"
          
          if [ "$PACKAGE_COUNT" -lt "100" ]; then
            echo "âŒ Lockfile still incomplete (only $PACKAGE_COUNT packages)"
            exit 1
          fi
          
          echo "âœ… Verified complete lockfile with $PACKAGE_COUNT packages"
          
      - name: Test installation
        if: steps.check.outputs.has_issues == 'true'
        run: |
          echo "ðŸ§ª Testing npm ci with fixed lockfile..."
          rm -rf node_modules
          npm ci
          echo "âœ… npm ci successful with fixed lockfile"
          
      - name: Generate fix summary
        if: steps.check.outputs.has_issues == 'true'
        id: summary
        run: |
          echo "ðŸ“Š Generating fix summary..."
          
          PACKAGE_COUNT=$(jq '.packages | length' package-lock.json)
          INTEGRITY_COUNT=$(jq '[.packages | to_entries[] | select(.value.integrity)] | length' package-lock.json)
          ISSUE_TYPE="${{ steps.check.outputs.issue_type }}"
          
          cat > fix-summary.md <<EOF
# Lockfile Integrity Fix Summary

## Problem Detected

EOF
          
          if [ "$ISSUE_TYPE" = "incomplete" ]; then
            cat >> fix-summary.md <<EOF
- âŒ Package-lock.json was incomplete (missing most dependencies)
- âŒ Only contained ~30 packages instead of 100+
- âŒ Missing complete dependency trees for devDependencies
EOF
          elif [ "$ISSUE_TYPE" = "placeholders" ]; then
            cat >> fix-summary.md <<EOF
- âŒ Package-lock.json contained placeholder integrity hashes
- âŒ This prevents proper dependency verification
EOF
          elif [ "$ISSUE_TYPE" = "missing" ]; then
            cat >> fix-summary.md <<EOF
- âŒ Package-lock.json was missing entirely
EOF
          fi
          
          cat >> fix-summary.md <<EOF

## Changes Made

- âœ… Regenerated complete package-lock.json with \`npm install\`
- ðŸ“¦ Now includes $PACKAGE_COUNT packages (complete dependency tree)
- ðŸ”’ All packages have valid integrity hashes ($INTEGRITY_COUNT packages)
- âœ… Verified with \`npm ci\`

## What This Fixes

- âœ… Ensures packages are verified against their checksums
- âœ… Prevents tampered or corrupted packages
- âœ… Enables security scanning and audit tools
- âœ… Ensures reproducible builds
- âœ… Complies with npm security best practices
- âœ… Fixes incomplete dependency resolution
- âœ… Includes all transitive dependencies

## Technical Details

**Generation method**: \`npm install\` (NOT \`--package-lock-only\`)
- This ensures complete dependency tree resolution
- Includes all transitive dependencies
- Properly resolves peer dependencies
- Generates valid integrity hashes for all packages

## Next Steps

1. Review the lockfile changes
2. Merge to enable proper dependency verification
3. All future installs will use \`npm ci\` for speed
4. Builds will be reproducible across all environments

---
*Generated automatically by fix-lockfile-integrity workflow*
*Run ID: ${{ github.run_id }}*
*Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")*
EOF
          
      - name: Create Pull Request
        if: steps.check.outputs.has_issues == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "fix: Regenerate complete package-lock.json with all dependencies"
          branch: fix-lockfile-integrity-${{ github.run_number }}
          delete-branch: true
          title: "ðŸ”’ Fix: Regenerate complete package-lock.json"
          body-path: fix-summary.md
          labels: |
            security
            dependencies
            automated
          assignees: ${{ github.actor }}
          
      - name: Workflow completion
        run: |
          if [ "${{ steps.check.outputs.has_issues }}" == "true" ]; then
            echo "ðŸŽ‰ Lockfile integrity fix workflow completed successfully!"
            echo ""
            echo "Summary:"
            cat fix-summary.md
          else
            echo "âœ… No integrity issues found - lockfile is healthy!"
          fi
