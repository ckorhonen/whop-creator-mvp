name: Fix Lockfile Integrity

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for integrity fix (optional)'
        required: false
        default: 'Fix package-lock.json integrity hashes'
  push:
    paths:
      - 'package.json'
    branches:
      - main
      - 'fix/workflow-circular-trigger'  # Allow testing on this branch

# Required permissions for create-pull-request action
permissions:
  contents: write
  pull-requests: write
  actions: write  # Added for workflow dispatch/management
  issues: write   # Sometimes needed for PR creation

jobs:
  fix-integrity:
    name: Fix Package Lockfile Integrity
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    # Prevent circular triggers - skip if:
    # 1. Commit message contains [skip ci] or [ci skip]
    # 2. Branch name starts with 'fix-lockfile-integrity-' (our own PR branches)
    if: |
      !contains(github.event.head_commit.message, '[skip ci]') &&
      !contains(github.event.head_commit.message, '[ci skip]') &&
      !startsWith(github.ref, 'refs/heads/fix-lockfile-integrity-')
    
    steps:
      - name: Debug - Check permissions
        run: |
          echo "üîç Checking workflow permissions..."
          echo "Repository: ${{ github.repository }}"
          echo "Actor: ${{ github.actor }}"
          echo "Event: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Run Number: ${{ github.run_number }}"
          echo "Token Permissions: This workflow has contents:write, pull-requests:write, actions:write"
          
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          # Note: npm cache is intentionally NOT enabled here because this workflow
          # is designed to fix broken/missing lockfiles. The cache setup requires
          # a valid package-lock.json which may not exist or be corrupted.
      
      - name: Install jq
        run: |
          echo "üì¶ Installing jq for JSON processing..."
          sudo apt-get update -qq
          sudo apt-get install -y jq
          echo "‚úÖ jq installed successfully"
          
      - name: Check for integrity issues
        id: check
        run: |
          echo "üîç Checking for integrity issues in package-lock.json..."
          
          if [ ! -f "package-lock.json" ]; then
            echo "‚ö†Ô∏è  package-lock.json not found"
            echo "has_issues=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check for example/placeholder integrity hashes
          if grep -q "example-integrity-hash\|example-.*-hash" package-lock.json; then
            echo "‚ùå Found placeholder integrity hashes"
            echo "has_issues=true" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ No placeholder integrity hashes found"
            echo "has_issues=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Clean npm state
        if: steps.check.outputs.has_issues == 'true'
        run: |
          echo "üßπ Cleaning npm cache and node_modules..."
          rm -rf node_modules package-lock.json
          npm cache clean --force
          
      - name: Validate package.json
        if: steps.check.outputs.has_issues == 'true'
        run: |
          echo "üìã Validating package.json..."
          if [ ! -f "package.json" ]; then
            echo "‚ùå package.json not found!"
            exit 1
          fi
          
          # Check if package.json is valid JSON
          if ! jq empty package.json 2>/dev/null; then
            echo "‚ùå package.json is not valid JSON!"
            exit 1
          fi
          
          echo "‚úÖ package.json is valid"
          
      - name: Regenerate lockfile with correct integrity
        if: steps.check.outputs.has_issues == 'true'
        run: |
          echo "üî® Regenerating package-lock.json with correct integrity hashes..."
          npm install --package-lock-only
          
          if [ ! -f "package-lock.json" ]; then
            echo "‚ùå Failed to generate package-lock.json"
            exit 1
          fi
          
          echo "‚úÖ package-lock.json regenerated successfully"
          
      - name: Verify integrity hashes
        if: steps.check.outputs.has_issues == 'true'
        run: |
          echo "üîç Verifying integrity hashes..."
          
          # Check that no placeholder hashes remain
          if grep -q "example-integrity-hash\|example-.*-hash" package-lock.json; then
            echo "‚ùå Still found placeholder integrity hashes after regeneration!"
            exit 1
          fi
          
          # Count packages with integrity
          INTEGRITY_COUNT=$(jq '[.packages | to_entries[] | select(.value.integrity)] | length' package-lock.json)
          echo "‚úÖ Verified $INTEGRITY_COUNT packages with valid integrity hashes"
          
      - name: Test installation
        if: steps.check.outputs.has_issues == 'true'
        run: |
          echo "üß™ Testing npm ci with fixed lockfile..."
          rm -rf node_modules
          npm ci
          echo "‚úÖ npm ci successful with fixed lockfile"
          
      - name: Generate fix summary
        if: steps.check.outputs.has_issues == 'true'
        id: summary
        run: |
          echo "üìä Generating fix summary..."
          
          PACKAGE_COUNT=$(jq '.packages | length' package-lock.json)
          INTEGRITY_COUNT=$(jq '[.packages | to_entries[] | select(.value.integrity)] | length' package-lock.json)
          
          # Store summary in output variable using heredoc
          {
            echo 'pr_body<<EOF_MARKER'
            echo "# Lockfile Integrity Fix Summary"
            echo ""
            echo "## Problem Detected"
            echo "- ‚ùå Package-lock.json contained placeholder integrity hashes"
            echo "- ‚ùå This prevents proper dependency verification"
            echo "- ‚ùå Causes security and reproducibility issues"
            echo ""
            echo "## Changes Made"
            echo "- ‚úÖ Regenerated package-lock.json with valid integrity hashes"
            echo "- üì¶ Fixed integrity for $INTEGRITY_COUNT packages in the lockfile"
            echo "- üîí Enabled proper dependency verification"
            echo ""
            echo "## What This Fixes"
            echo "- ‚úÖ Ensures packages are verified against their checksums"
            echo "- ‚úÖ Prevents tampered or corrupted packages"
            echo "- ‚úÖ Enables security scanning and audit tools"
            echo "- ‚úÖ Ensures reproducible builds"
            echo "- ‚úÖ Complies with npm security best practices"
            echo ""
            echo "## Next Steps"
            echo "1. Review the integrity hash changes"
            echo "2. Merge to enable proper dependency verification"
            echo "3. All future installs will verify package integrity"
            echo ""
            echo "---"
            echo "*Generated automatically by fix-lockfile-integrity workflow*"
            echo 'EOF_MARKER'
          } >> $GITHUB_OUTPUT
          
          echo "Package count: $PACKAGE_COUNT"
          echo "Integrity count: $INTEGRITY_COUNT"
          
      - name: Create Pull Request
        if: steps.check.outputs.has_issues == 'true'
        id: create-pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "fix: Regenerate package-lock.json with correct integrity hashes [skip ci]"
          branch: fix-lockfile-integrity-${{ github.run_number }}
          delete-branch: true
          title: "üîí Fix: Regenerate package-lock.json with correct integrity hashes"
          body: ${{ steps.summary.outputs.pr_body }}
          labels: security,dependencies,automated
          assignees: ${{ github.actor }}
        continue-on-error: true
          
      - name: Check PR creation result
        if: steps.check.outputs.has_issues == 'true'
        run: |
          if [ "${{ steps.create-pr.outcome }}" == "failure" ]; then
            echo "‚ö†Ô∏è  Failed to create pull request"
            echo "This might be due to:"
            echo "  - Insufficient permissions for GITHUB_TOKEN"
            echo "  - Repository settings preventing automated PRs"
            echo "  - A PR from the same branch already exists"
            echo ""
            echo "However, the lockfile has been fixed successfully."
            echo "You may need to manually commit the changes."
            exit 0
          else
            echo "‚úÖ Pull request created successfully!"
            echo "PR Number: ${{ steps.create-pr.outputs.pull-request-number }}"
            echo "PR URL: ${{ steps.create-pr.outputs.pull-request-url }}"
          fi
          
      - name: Workflow completion
        run: |
          if [ "${{ steps.check.outputs.has_issues }}" == "true" ]; then
            echo "üéâ Lockfile integrity fix workflow completed successfully!"
            echo ""
            echo "A pull request has been created with the fixes."
          else
            echo "‚úÖ No integrity issues found - lockfile is healthy!"
          fi
