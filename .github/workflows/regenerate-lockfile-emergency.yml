name: Emergency Lockfile Regeneration

on:
  workflow_dispatch:
  push:
    branches:
      - fix/regenerate-complete-package-lockfile

permissions:
  contents: write

jobs:
  regenerate-lockfile:
    name: Regenerate Complete Lockfile
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: fix/regenerate-complete-package-lockfile
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Check current lockfile status
        run: |
          echo "ðŸ“Š Current lockfile status:"
          if [ -f "package-lock.json" ]; then
            SIZE=$(wc -c < package-lock.json)
            echo "Size: $SIZE bytes"
            PACKAGE_COUNT=$(jq '.packages | length' package-lock.json 2>/dev/null || echo "0")
            echo "Packages: $PACKAGE_COUNT"
          else
            echo "No lockfile found"
          fi
          
      - name: Clean and regenerate lockfile
        run: |
          echo "ðŸ§¹ Cleaning up..."
          rm -rf node_modules package-lock.json
          npm cache clean --force
          
          echo "ðŸ”¨ Regenerating complete lockfile..."
          npm install
          
          echo "âœ… Lockfile regenerated!"
          
      - name: Verify new lockfile
        run: |
          echo "ðŸ“Š New lockfile status:"
          SIZE=$(wc -c < package-lock.json)
          echo "Size: $SIZE bytes"
          
          PACKAGE_COUNT=$(jq '.packages | length' package-lock.json)
          echo "Packages: $PACKAGE_COUNT"
          
          if [ "$PACKAGE_COUNT" -lt "100" ]; then
            echo "âŒ Error: Lockfile still incomplete ($PACKAGE_COUNT packages)"
            echo "Expected at least 100 packages"
            exit 1
          fi
          
          echo "âœ… Lockfile looks good with $PACKAGE_COUNT packages"
          
      - name: Test installation
        run: |
          echo "ðŸ§ª Testing npm ci..."
          rm -rf node_modules
          npm ci
          echo "âœ… npm ci successful!"
          
      - name: Commit regenerated lockfile
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if [ -n "$(git status --porcelain package-lock.json)" ]; then
            git add package-lock.json
            git commit -m "Fix: Regenerate complete package-lock.json with all dependencies

This regenerates the package-lock.json from scratch to include all nested
dependencies. The previous lockfile was incomplete with only ~60 packages
when it should have 1,000+ packages.

Fixes workflow run #19203303362

Changes:
- Complete lockfile with all transitive dependencies
- Proper integrity hashes for all packages
- Enables npm caching and reproducible builds
- Fixes fix-lockfile-integrity.yml workflow

Generated by emergency lockfile regeneration workflow"
            git push
            echo "âœ… Committed and pushed regenerated lockfile"
          else
            echo "â„¹ï¸  No changes to lockfile"
          fi
