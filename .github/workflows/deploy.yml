name: Deploy to Cloudflare Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Validate Environment
        run: |
          echo "üîç Validating environment..."
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"
          echo "Working directory: $(pwd)"
          echo ""
          echo "üìã Checking for required files..."
          if [ ! -f package.json ]; then
            echo "‚ùå Error: package.json not found"
            exit 1
          fi
          echo "‚úÖ package.json found"
          
          if [ -f package-lock.json ]; then
            echo "‚úÖ package-lock.json found"
          else
            echo "‚ö†Ô∏è  Warning: package-lock.json not found"
            echo "   Consider running 'npm install' locally and committing the lock file"
          fi
      
      - name: Check GitHub Secrets
        run: |
          echo "üîê Validating GitHub Secrets..."
          SECRETS_OK=true
          
          if [ -z "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]; then
            echo "‚ùå CLOUDFLARE_API_TOKEN secret is missing"
            echo "   ‚Üí Go to: Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "   ‚Üí Get token from: https://dash.cloudflare.com/profile/api-tokens"
            SECRETS_OK=false
          else
            echo "‚úÖ CLOUDFLARE_API_TOKEN is configured"
          fi
          
          if [ -z "${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" ]; then
            echo "‚ùå CLOUDFLARE_ACCOUNT_ID secret is missing"
            echo "   ‚Üí Go to: Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "   ‚Üí Find in Cloudflare dashboard URL or sidebar"
            SECRETS_OK=false
          else
            echo "‚úÖ CLOUDFLARE_ACCOUNT_ID is configured"
          fi
          
          if [ "$SECRETS_OK" = false ]; then
            echo ""
            echo "‚ö†Ô∏è  Deployment will fail without these secrets!"
            exit 1
          fi
          echo "‚úÖ All required secrets are configured"
      
      - name: Install dependencies
        run: |
          echo "üì¶ Installing dependencies..."
          if [ -f package-lock.json ]; then
            echo "Using npm ci (faster, requires lock file)"
            npm ci
          else
            echo "Using npm install (no lock file found)"
            npm install
          fi
          echo "‚úÖ Dependencies installed successfully"
      
      - name: Build project
        run: |
          echo "üî® Building project..."
          echo "Running: npm run build"
          npm run build
          echo "‚úÖ Build completed successfully"
      
      - name: Verify build output
        run: |
          echo "üîç Verifying build output..."
          if [ ! -d "dist" ]; then
            echo "‚ùå Error: dist directory not found after build!"
            echo "   The build step may have failed silently."
            echo "   Check the 'Build project' step logs above for errors."
            exit 1
          fi
          
          if [ ! "$(ls -A dist)" ]; then
            echo "‚ùå Error: dist directory is empty!"
            exit 1
          fi
          
          echo "‚úÖ dist directory exists and contains files:"
          ls -lah dist/ | head -20
          
          FILE_COUNT=$(find dist -type f | wc -l)
          DIR_SIZE=$(du -sh dist | cut -f1)
          echo ""
          echo "üìä Build statistics:"
          echo "   Files: $FILE_COUNT"
          echo "   Size: $DIR_SIZE"
      
      - name: Deploy to Cloudflare Pages
        id: deploy
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dist --project-name=whop-creator-mvp
      
      - name: Deployment summary
        if: success()
        run: |
          echo "üéâ =================================="
          echo "üéâ  DEPLOYMENT SUCCESSFUL!"
          echo "üéâ =================================="
          echo ""
          echo "üåê Your application is now live!"
          echo ""
          echo "üìç URLs:"
          echo "   Production: https://whop-creator-mvp.pages.dev"
          echo "   Dashboard: https://dash.cloudflare.com/"
          echo ""
          echo "‚ú® Next steps:"
          echo "   1. Visit your site to verify deployment"
          echo "   2. Check Cloudflare dashboard for analytics"
          echo "   3. Configure custom domains if needed"
      
      - name: Deployment failure help
        if: failure()
        run: |
          echo "‚ùå =================================="
          echo "‚ùå  DEPLOYMENT FAILED"
          echo "‚ùå =================================="
          echo ""
          echo "üîç Common issues and solutions:"
          echo ""
          echo "1. Missing Secrets:"
          echo "   ‚Üí Check Settings ‚Üí Secrets and variables ‚Üí Actions"
          echo "   ‚Üí Ensure CLOUDFLARE_API_TOKEN and CLOUDFLARE_ACCOUNT_ID are set"
          echo ""
          echo "2. Project doesn't exist:"
          echo "   ‚Üí Go to https://dash.cloudflare.com/"
          echo "   ‚Üí Navigate to Workers & Pages"
          echo "   ‚Üí Create project named: whop-creator-mvp"
          echo ""
          echo "3. Invalid API token:"
          echo "   ‚Üí Token may be expired or have wrong permissions"
          echo "   ‚Üí Needs 'Edit Cloudflare Pages' permission"
          echo "   ‚Üí Regenerate at: https://dash.cloudflare.com/profile/api-tokens"
          echo ""
          echo "4. Build failures:"
          echo "   ‚Üí Check the 'Build project' step logs above"
          echo "   ‚Üí Look for TypeScript or dependency errors"
          echo ""
          echo "üìö See DEPLOYMENT_TROUBLESHOOTING.md for detailed guide"
