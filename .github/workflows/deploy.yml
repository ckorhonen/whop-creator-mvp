name: Deploy to Cloudflare Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy
    timeout-minutes: 20
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
        timeout-minutes: 2
      
      - name: Debug - Show environment
        run: |
          echo "=== Environment Debug Info ==="
          echo "Working directory: $(pwd)"
          echo "Repository contents:"
          ls -la
          echo "Git status:"
          git status || echo "Git not initialized"
          echo "Runner OS: ${{ runner.os }}"
          echo "Runner architecture: ${{ runner.arch }}"
          echo "=============================="
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          # Enable caching when package-lock.json exists
          cache: ${{ hashFiles('package-lock.json') != '' && 'npm' || '' }}
        timeout-minutes: 3
      
      - name: Validate Environment
        run: |
          echo "=== Environment Validation ==="
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"
          echo "Current directory: $(pwd)"
          echo "Checking for package.json..."
          if [ ! -f package.json ]; then
            echo "‚ùå Error: package.json not found"
            echo "Directory contents:"
            ls -la
            exit 1
          fi
          echo "‚úÖ package.json found"
          echo "Package.json contents:"
          cat package.json
          echo "=============================="
          
      - name: Check GitHub Secrets
        id: check_secrets
        run: |
          echo "=== Checking Secrets Configuration ==="
          SECRETS_MISSING=false
          
          if [ -z "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]; then
            echo "‚ö†Ô∏è  Warning: CLOUDFLARE_API_TOKEN secret is not set"
            echo "Please add it in Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "Get your token from: https://dash.cloudflare.com/profile/api-tokens"
            SECRETS_MISSING=true
          else
            echo "‚úÖ CLOUDFLARE_API_TOKEN is configured"
          fi
          
          if [ -z "${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" ]; then
            echo "‚ö†Ô∏è  Warning: CLOUDFLARE_ACCOUNT_ID secret is not set"
            echo "Please add it in Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "Find your Account ID in the Cloudflare dashboard"
            SECRETS_MISSING=true
          else
            echo "‚úÖ CLOUDFLARE_ACCOUNT_ID is configured"
          fi
          
          if [ "$SECRETS_MISSING" = true ]; then
            echo "secrets_configured=false" >> $GITHUB_OUTPUT
            echo ""
            echo "‚ÑπÔ∏è  Build will continue, but deployment will be skipped"
          else
            echo "secrets_configured=true" >> $GITHUB_OUTPUT
            echo "‚úÖ All required secrets are configured"
          fi
          echo "=============================="
      
      - name: Check npm Registry Connectivity
        id: npm_check
        continue-on-error: true
        run: |
          echo "=== Checking npm Registry Connectivity ==="
          if curl -I --max-time 10 https://registry.npmjs.org/ 2>&1 | grep -q "200 OK"; then
            echo "‚úÖ npm registry is accessible"
            echo "registry_available=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è  Warning: npm registry may be unreachable"
            echo "Will attempt install with retries"
            echo "registry_available=false" >> $GITHUB_OUTPUT
          fi
          echo "=============================="
      
      - name: Install dependencies
        run: |
          echo "=== Installing Dependencies ==="
          
          # Configure npm for better reliability
          npm config set fetch-retries 3
          npm config set fetch-retry-mintimeout 20000
          npm config set fetch-retry-maxtimeout 120000
          npm config set fetch-timeout 60000
          
          # Check if package-lock.json exists and is complete
          USE_NPM_CI=false
          if [ -f package-lock.json ]; then
            # Check if the lockfile has actual package data
            # Complete lockfiles have hundreds of lines; incomplete ones have < 30
            LOCKFILE_SIZE=$(wc -l < package-lock.json)
            if [ "$LOCKFILE_SIZE" -gt 30 ]; then
              echo "‚úÖ Found complete package-lock.json ($LOCKFILE_SIZE lines)"
              echo "Using npm ci for fast, reproducible installation"
              USE_NPM_CI=true
            else
              echo "‚ö†Ô∏è  Warning: package-lock.json exists but appears incomplete ($LOCKFILE_SIZE lines)"
              echo "An incomplete lockfile will cause npm ci to fail"
              echo "Using npm install instead"
            fi
          else
            echo "‚ö†Ô∏è  Warning: package-lock.json not found"
            echo "Using npm install (slower and less reproducible)"
            echo ""
            echo "üí° To generate a lockfile:"
            echo "   1. Go to Actions tab"
            echo "   2. Run 'Generate package-lock.json' workflow"
            echo "   3. Merge the resulting PR"
          fi
          
          # Function to try npm install with retries
          install_dependencies() {
            local max_retries=3  # Increased from 2
            local retry_count=0
            local backoff_time=5
            
            while [ $retry_count -le $max_retries ]; do
              if [ $retry_count -gt 0 ]; then
                echo ""
                echo "‚ö†Ô∏è  Retry attempt $retry_count of $max_retries"
                echo "Waiting ${backoff_time}s before retry..."
                sleep $backoff_time
                
                echo "Cleaning npm cache..."
                npm cache clean --force
                npm cache verify
                
                # Exponential backoff
                backoff_time=$((backoff_time + 5))
              fi
              
              echo ""
              echo "üì¶ Installing dependencies (attempt $((retry_count + 1)))..."
              
              if [ "$USE_NPM_CI" = true ]; then
                # Try npm ci first
                if npm ci --loglevel=error 2>&1 | tee npm-install.log; then
                  echo "‚úÖ Dependencies installed successfully with npm ci"
                  return 0
                else
                  echo "‚ùå npm ci failed, checking if lockfile is corrupted..."
                  # If npm ci fails, lockfile might be incomplete/corrupted
                  # Fall back to npm install on next retry
                  USE_NPM_CI=false
                  echo "‚ö†Ô∏è  Will use npm install on next attempt"
                fi
              else
                # Use npm install with prefer-offline on retries
                local npm_flags="--loglevel=error"
                if [ $retry_count -gt 0 ]; then
                  npm_flags="$npm_flags --prefer-offline"
                fi
                
                if npm install $npm_flags 2>&1 | tee npm-install.log; then
                  echo "‚úÖ Dependencies installed successfully with npm install"
                  return 0
                fi
              fi
              
              retry_count=$((retry_count + 1))
              
              if [ $retry_count -le $max_retries ]; then
                echo "‚ùå Installation failed, will retry..."
                echo "Last error from npm:"
                tail -n 20 npm-install.log
              fi
            done
            
            echo ""
            echo "‚ùå Failed to install dependencies after $((max_retries + 1)) attempts"
            echo ""
            echo "üîç Troubleshooting information:"
            echo "- npm version: $(npm --version)"
            echo "- Node version: $(node --version)"
            echo "- npm config:"
            npm config list
            echo ""
            echo "- Last 50 lines of npm output:"
            tail -n 50 npm-install.log || cat npm-install.log
            echo ""
            echo "- Network connectivity check:"
            curl -v https://registry.npmjs.org/ || echo "Cannot reach npm registry"
            echo ""
            echo "üí° Possible solutions:"
            echo "1. Re-run this workflow (may be a transient npm registry issue)"
            echo "2. Generate package-lock.json via the 'Generate package-lock.json' workflow"
            echo "3. Check if all packages in package.json are available on npm"
            echo "4. Verify network connectivity to registry.npmjs.org"
            return 1
          }
          
          # Run the installation
          if ! install_dependencies; then
            exit 1
          fi
          
          # Show installed packages
          echo ""
          echo "üìã Installed packages:"
          npm list --depth=0 || echo "Unable to list packages"
          
          echo ""
          echo "üí° Performance tip:"
          echo "   Generate and commit package-lock.json to speed up future builds by 2-3x"
          echo "=============================="
        timeout-minutes: 12  # Increased to 12 for maximum reliability
        env:
          NPM_CONFIG_LOGLEVEL: error
      
      - name: Type Check
        continue-on-error: true
        run: |
          echo "=== Running Type Check ==="
          if npm run typecheck 2>&1 | tee typecheck.log; then
            echo "‚úÖ Type check passed"
          else
            echo "‚ö†Ô∏è  TypeScript errors found, but continuing with build"
            echo "Errors:"
            cat typecheck.log
            echo ""
            echo "Fix these issues in your next commit"
          fi
          echo "=============================="
        timeout-minutes: 3
      
      - name: Build
        run: |
          echo "=== Building Project ==="
          
          # Pre-build validation
          echo "Validating build configuration..."
          if [ ! -f vite.config.ts ]; then
            echo "‚ùå Error: vite.config.ts not found"
            echo "Cannot proceed with build"
            exit 1
          fi
          echo "‚úÖ vite.config.ts found"
          
          echo ""
          echo "Starting build process..."
          if npm run build 2>&1 | tee build.log; then
            echo ""
            echo "‚úÖ Build completed successfully"
          else
            echo ""
            echo "‚ùå Build failed!"
            echo ""
            echo "üîç Build error details:"
            echo "Last 100 lines of build output:"
            tail -n 100 build.log || cat build.log
            echo ""
            echo "üí° Common build issues:"
            echo "1. TypeScript errors (check 'npm run typecheck' output above)"
            echo "2. Missing dependencies (re-run npm install)"
            echo "3. Import path errors (check file paths in source)"
            echo "4. Vite configuration errors (check vite.config.ts)"
            exit 1
          fi
          echo "=============================="
        timeout-minutes: 8
      
      - name: Verify Build Output
        run: |
          echo "=== Verifying Build Output ==="
          if [ ! -d "dist" ]; then
            echo "‚ùå Error: dist directory not found after build"
            echo "Build may have failed silently. Check the Build step logs above."
            echo "Current directory contents:"
            ls -la
            exit 1
          fi
          echo "‚úÖ dist directory exists"
          echo ""
          echo "Contents of dist directory:"
          ls -la dist/
          echo ""
          echo "Build size:"
          du -sh dist/
          echo ""
          echo "File count:"
          find dist -type f | wc -l
          echo ""
          echo "Key files present:"
          [ -f dist/index.html ] && echo "‚úÖ index.html" || echo "‚ùå index.html missing"
          find dist -name "*.js" | head -1 > /dev/null && echo "‚úÖ JavaScript files" || echo "‚ùå No JavaScript files"
          find dist -name "*.css" | head -1 > /dev/null && echo "‚úÖ CSS files" || echo "‚ö†Ô∏è  No CSS files (may be normal)"
          echo "=============================="
      
      - name: Deploy to Cloudflare Pages
        if: steps.check_secrets.outputs.secrets_configured == 'true'
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dist --project-name=whop-creator-mvp
        timeout-minutes: 5
          
      - name: Deployment Skipped
        if: steps.check_secrets.outputs.secrets_configured != 'true'
        run: |
          echo "=== Deployment Status ==="
          echo "‚ö†Ô∏è  Deployment skipped - Cloudflare secrets not configured"
          echo ""
          echo "To enable deployment:"
          echo "1. Go to https://github.com/${{ github.repository }}/settings/secrets/actions"
          echo "2. Add CLOUDFLARE_API_TOKEN (get from Cloudflare dashboard)"
          echo "3. Add CLOUDFLARE_ACCOUNT_ID (find in Cloudflare dashboard)"
          echo ""
          echo "‚úÖ Build completed successfully!"
          echo "=============================="
      
      - name: Upload Build Artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            npm-install.log
            build.log
            typecheck.log
          if-no-files-found: ignore
          retention-days: 7
      
      - name: Workflow Summary
        if: always()
        run: |
          echo "=== Workflow Completion Summary ==="
          echo "Workflow completed at: $(date)"
          echo "Status: ${{ job.status }}"
          if [ "${{ job.status }}" = "success" ]; then
            echo "‚úÖ All steps completed successfully"
          else
            echo "‚ùå Workflow failed - check logs above"
            echo "Artifacts with logs have been uploaded"
          fi
          echo "=============================="
